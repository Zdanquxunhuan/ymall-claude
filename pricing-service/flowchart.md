# 交易前置算价与锁价流程

## 整体流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           交易前置算价与锁价流程                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  用户端   │     │ pricing-svc  │     │promotion-svc │     │  order-svc   │
└────┬─────┘     └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
     │                  │                    │                    │
     │  1. 选择商品      │                    │                    │
     │  加入购物车       │                    │                    │
     │                  │                    │                    │
     ├─────────────────►│                    │                    │
     │  2. POST /quote  │                    │                    │
     │  (试算请求)       │                    │                    │
     │                  ├───────────────────►│                    │
     │                  │  3. 查询可用优惠券   │                    │
     │                  │     计算优惠金额    │                    │
     │                  │◄───────────────────┤                    │
     │                  │  4. 返回试算结果    │                    │
     │◄─────────────────┤                    │                    │
     │  5. 返回:         │                    │                    │
     │  - 原价/优惠/应付  │                    │                    │
     │  - 分摊明细       │                    │                    │
     │  - 可用优惠券     │                    │                    │
     │                  │                    │                    │
     │  6. 用户确认下单   │                    │                    │
     │  选择优惠券       │                    │                    │
     │                  │                    │                    │
     ├─────────────────►│                    │                    │
     │  7. POST /lock   │                    │                    │
     │  (锁价请求)       │                    │                    │
     │                  ├───────────────────►│                    │
     │                  │  8. 锁定优惠券      │                    │
     │                  │◄───────────────────┤                    │
     │                  │                    │                    │
     │                  │  9. 生成价格锁      │                    │
     │                  │  - 保存快照        │                                    │  - 计算签名        │                    │
     │                  │  - 设置过期时间    │                    │
     │◄─────────────────┤                    │                    │
     │  10. 返回:        │                    │                    │
     │  - priceLockNo   │                    │                    │
     │  - signature     │                    │                    │
     │  - 分摊明细       │                    │                    │
     │                  │                    │                    │
     ├─────────────────────────────────────────────────────────►│
     │  11. 创建订单                                             │
     │  (携带priceLockNo + signature)                           │
     │                  │                    │                    │
     │                  │◄───────────────────────────────────────┤
     │                  │  12. 验证签名 + 使用价格锁               │
     │                  ├───────────────────────────────────────►│
     │                  │  13. 返回锁价信息                        │
     │                  │                    │                    │
     │                  │                    │◄───────────────────┤
     │                  │                    │  14. 核销优惠券     │
     │                  │                    ├───────────────────►│
     │◄─────────────────────────────────────────────────────────┤
     │  15. 订单创建成功                                          │
     │                  │                    │                    │
     ▼                  ▼                    ▼                    ▼
```

## 详细流程说明

### 阶段一：试算 (Quote)

```
┌─────────────────────────────────────────────────────────────┐
│                        试算流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  输入:                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ {                                                    │   │
│  │   "userId": 10001,                                   │   │
│  │   "items": [                                         │   │
│  │     {"skuId": 1001, "qty": 2, "unitPrice": 99.00},  │   │
│  │     {"skuId": 1002, "qty": 1, "unitPrice": 199.00}  │   │
│  │   ],                                                 │   │
│  │   "userCouponNos": ["UC20240101001"]                │   │
│  │ }                                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              计算商品原价总额                         │   │
│  │         99.00 * 2 + 199.00 * 1 = 397.00             │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              调用促销服务试算                         │   │
│  │         - 查询用户可用优惠券                         │   │
│  │         - 检查门槛条件                               │   │
│  │         - 计算优惠金额                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              计算分摊明细                             │   │
│  │         按金额比例分摊优惠到每个订单行                 │   │
│  │                                                      │   │
│  │  SKU 1001: 原价198.00, 优惠24.87, 应付173.13        │   │
│  │  SKU 1002: 原价199.00, 优惠25.13, 应付173.87        │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  输出:                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ {                                                    │   │
│  │   "originalAmount": 397.00,                         │   │
│  │   "totalDiscount": 50.00,                           │   │
│  │   "payableAmount": 347.00,                          │   │
│  │   "allocations": [...],                             │   │
│  │   "availableCoupons": [...]                         │   │
│  │ }                                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 阶段二：锁价 (Lock)

```
┌─────────────────────────────────────────────────────────────┐
│                        锁价流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 重新计算试算结果（确保最新）                              │
│                           │                                 │
│                           ▼                                 │
│  2. 锁定优惠券                                               │
│     ┌─────────────────────────────────────────────────┐    │
│     │  UPDATE t_coupon_user                           │    │
│     │  SET status = 'LOCKED',                         │    │
│     │      price_lock_no = 'PL20240101001',          │    │
│     │      lock_expire_time = '2024-01-01 12:15:00'  │    │
│     │  WHERE user_coupon_no = 'UC20240101001'        │    │
│     │    AND status = 'AVAILABLE'                     │    │
│     └─────────────────────────────────────────────────┘    │
│                           │                                 │
│                           ▼                                 │
│  3. 生成价格锁                                               │
│     ┌─────────────────────────────────────────────────┐    │
│     │  priceLockNo: PL20240101123456001               │    │
│     │  expireAt: 当前时间 + 15分钟                     │    │
│     └─────────────────────────────────────────────────┘    │
│                           │                                 │
│                           ▼                                 │
│  4. 保存锁价快照                                             │
│     ┌─────────────────────────────────────────────────┐    │
│     │  snapshot_json: {                               │    │
│     │    userId, items, userCouponNos,               │    │
│     │    originalAmount, totalDiscount, payableAmount,│    │
│     │    hitRules, allocations                        │    │
│     │  }                                              │    │
│     └─────────────────────────────────────────────────┘    │
│                           │                                 │
│                           ▼                                 │
│  5. 生成防篡改签名                                           │
│     ┌─────────────────────────────────────────────────┐    │
│     │  signature = SHA256(                            │    │
│     │    priceLockNo + userId + payableAmount +       │    │
│     │    snapshot + secretKey                         │    │
│     │  )                                              │    │
│     └─────────────────────────────────────────────────┘    │
│                           │                                 │
│                           ▼                                 │
│  输出:                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ {                                                    │   │
│  │   "priceLockNo": "PL20240101123456001",             │   │
│  │   "signature": "a1b2c3d4...",                       │   │
│  │   "signVersion": 1,                                 │   │
│  │   "expireAt": "2024-01-01T12:15:00",               │   │
│  │   "payableAmount": 347.00,                          │   │
│  │   "allocations": [...]                              │   │
│  │ }                                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 阶段三：下单使用锁价

```
┌─────────────────────────────────────────────────────────────┐
│                      下单使用锁价流程                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 订单服务收到下单请求                                      │
│     ┌─────────────────────────────────────────────────┐    │
│     │  {                                              │    │
│     │    "priceLockNo": "PL20240101123456001",       │    │
│     │    "signature": "a1b2c3d4...",                 │    │
│     │    ...                                          │    │
│     │  }                                              │    │
│     └─────────────────────────────────────────────────┘    │
│                           │                                 │
│                           ▼                                 │
│  2. 调用定价服务验证并使用价格锁                              │
│     ┌─────────────────────────────────────────────────┐    │
│     │  POST /pricing/lock/{priceLockNo}/use          │    │
│     │  - 验证签名                                     │    │
│     │  - 检查状态 = LOCKED                           │    │
│     │  - 检查未过期                                   │    │
│     │  - CAS更新状态为 USED                          │    │
│     └─────────────────────────────────────────────────┘    │
│                           │                                 │
│                           ▼                                 │
│  3. 核销优惠券                                               │
│     ┌─────────────────────────────────────────────────┐    │
│     │  POST /promotion/coupon/redeem                 │    │
│     │  - 更新状态为 USED                              │    │
│     │  - 记录使用订单号                               │    │
│     │  - 记录实际优惠金额                             │    │
│     └─────────────────────────────────────────────────┘    │
│                           │                                 │
│                           ▼                                 │
│  4. 创建订单                                                 │
│     ┌─────────────────────────────────────────────────┐    │
│     │  - 使用锁价快照中的分摊明细                      │    │
│     │  - 保存订单行的优惠信息                         │    │
│     │  - 订单金额 = 锁价的应付金额                    │    │
│     └─────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 分摊算法

```
┌─────────────────────────────────────────────────────────────┐
│                      分摊算法说明                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  原则：按金额比例分摊，最后一行用减法避免精度问题              │
│                                                             │
│  示例：                                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  商品A: 单价100, 数量2, 行原价200                    │   │
│  │  商品B: 单价150, 数量1, 行原价150                    │   │
│  │  总原价: 350                                         │   │
│  │  总优惠: 50 (满300减50)                              │   │
│  │                                                      │   │
│  │  商品A分摊: 50 * (200/350) = 28.57                  │   │
│  │  商品B分摊: 50 - 28.57 = 21.43 (最后一行用减法)     │   │
│  │                                                      │   │
│  │  商品A应付: 200 - 28.57 = 171.43                    │   │
│  │  商品B应付: 150 - 21.43 = 128.57                    │   │
│  │  总应付: 171.43 + 128.57 = 300.00 ✓                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  可审计性：                                                  │
│  - 每行的 lineOriginalAmount - lineDiscountAmount           │
│    = linePayableAmount                                      │
│  - 所有行的 linePayableAmount 之和 = payableAmount          │
│  - 所有行的 lineDiscountAmount 之和 = totalDiscount         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 异常处理

```
┌─────────────────────────────────────────────────────────────┐
│                      异常处理流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 价格锁过期                                               │
│     ┌─────────────────────────────────────────────────┐    │
│     │  定时任务扫描过期的价格锁                        │    │
│     │  - 更新状态为 EXPIRED                           │    │
│     │  - 解锁关联的优惠券                             │    │
│     └─────────────────────────────────────────────────┘    │
│                                                             │
│  2. 下单失败回滚                                             │
│     ┌─────────────────────────────────────────────────┐    │
│     │  调用 POST /pricing/lock/{priceLockNo}/cancel  │    │
│     │  - 更新状态为 CANCELED                          │    │
│     │  - 解锁关联的优惠券                             │    │
│     └─────────────────────────────────────────────────┘    │
│                                                             │
│  3. 签名验证失败                                             │
│     ┌─────────────────────────────────────────────────┐    │
│     │  返回错误: "签名验证失败"                        │    │
│     │  可能原因: 数据被篡改                           │    │
│     └─────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 状态流转

### 价格锁状态

```
                    ┌─────────┐
                    │ LOCKED  │
                    └────┬────┘
                         │
           ┌─────────────┼─────────────┐
           │             │             │
           ▼             ▼             ▼
      ┌────────┐   ┌──────────┐  ┌──────────┐
      │  USED  │   │ EXPIRED  │  │ CANCELED │
      └────────┘   └──────────┘  └──────────┘
```

### 用户优惠券状态

```
                    ┌───────────┐
                    │ AVAILABLE │
                    └─────┬─────┘
                          │
            ┌─────────────┼─────────────┐
            │             │             │
            ▼             ▼             ▼
       ┌────────┐   ┌──────────┐  ┌──────────┐
       │ LOCKED │   │   USED   │  │ EXPIRED  │
       └────┬───┘   └──────────┘  └──────────┘
            │
            ├─────────────┬─────────────┐
            │             │             │
            ▼             ▼             ▼
       ┌────────┐   ┌──────────┐  ┌───────────┐
       │  USED  │   │ AVAILABLE│  │  EXPIRED  │
       └────────┘   │ (解锁)    │  │ (锁过期)  │
                    └──────────┘  └───────────┘
```
