# Inventory Service 流程图

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Order Service                                   │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                      │
│  │ Create Order│───▶│ Write Outbox│───▶│ Relay Worker│                      │
│  └─────────────┘    └─────────────┘    └──────┬──────┘                      │
└──────────────────────────────────────────────┼──────────────────────────────┘
                                               │
                                               ▼
                                    ┌─────────────────────┐
                                    │     RocketMQ        │
                                    │  ORDER_TOPIC:       │
                                    │  ORDER_CREATED      │
                                    └──────────┬──────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Inventory Service                                 │
│  ┌──────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │OrderCreatedConsumer│──▶│InventoryService │───▶│InventoryRedis   │        │
│  │  (MQ Consumer)    │    │  (TryReserve)   │    │   Service       │        │
│  └──────────────────┘    └────────┬────────┘    │  (Lua Scripts)  │        │
│                                   │             └────────┬────────┘        │
│                                   │                      │                  │
│                                   ▼                      ▼                  │
│                          ┌───────────────┐      ┌───────────────┐          │
│                          │   MySQL DB    │      │    Redis      │          │
│                          │ t_inventory   │      │ inv:{w}:{sku} │          │
│                          │ t_reservation │      └───────────────┘          │
│                          │ t_txn         │                                  │
│                          └───────────────┘                                  │
│                                   │                                         │
│                                   ▼                                         │
│                          ┌───────────────┐                                  │
│                          │ ProducerTemplate│                                │
│                          └───────┬───────┘                                  │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
                        ┌─────────────────────┐
                        │     RocketMQ        │
                        │  INVENTORY_TOPIC:   │
                        │  STOCK_RESERVED /   │
                        │  STOCK_RESERVE_FAILED│
                        └─────────────────────┘
```

## 2. 库存预留流程 (TryReserve)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         TryReserve Flow                                       │
└──────────────────────────────────────────────────────────────────────────────┘

    OrderCreated Event
           │
           ▼
    ┌──────────────┐
    │ 1. 幂等检查   │  查询 t_mq_consume_log
    │   (MQ层)     │  是否已消费过该eventId
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 2. 幂等检查   │  查询 t_inventory_reservation
    │   (业务层)   │  是否已有该订单的预留记录
    └──────┬───────┘
           │ 不存在
           ▼
    ┌──────────────────────────────────────────────────────────────┐
    │ 3. Redis Lua 原子预扣                                         │
    │                                                               │
    │   KEYS[1] = inv:{warehouseId}:{skuId}                        │
    │   KEYS[2] = inv:reserved:{orderNo}:{warehouseId}:{skuId}     │
    │                                                               │
    │   ┌─────────────────────────────────────────────────────┐    │
    │   │ -- 检查幂等标记                                       │    │
    │   │ if EXISTS(KEYS[2]) then return 0 end                 │    │
    │   │                                                       │    │
    │   │ -- 检查库存                                           │    │
    │   │ available = GET(KEYS[1])                              │    │
    │   │ if available < qty then return -1 end                 │    │
    │   │                                                       │    │
    │   │ -- 扣减库存                                           │    │
    │   │ SET(KEYS[1], available - qty)                         │    │
    │   │                                                       │    │
    │   │ -- 设置幂等标记(带过期时间)                            │    │
    │   │ SETEX(KEYS[2], 86400, qty)                            │    │
    │   │                                                       │    │
    │   │ return newAvailable                                   │    │
    │   └─────────────────────────────────────────────────────┘    │
    └──────────────────────────────────────────────────────────────┘
           │
           │ 成功
           ▼
    ┌──────────────┐
    │ 4. 落库      │  INSERT t_inventory_reservation
    │  Reservation │  (唯一约束保证幂等)
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 5. 更新DB库存│  CAS UPDATE t_inventory
    │   (CAS)      │  available -= qty, reserved += qty
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 6. 记录流水  │  INSERT t_inventory_txn
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 7. 发布事件  │  StockReserved / StockReserveFailed
    └──────────────┘
```

## 3. 库存确认流程 (Confirm)

```
    PaymentSuccess Event
           │
           ▼
    ┌──────────────┐
    │ 1. 查询预留  │  SELECT * FROM t_inventory_reservation
    │   记录       │  WHERE order_no = ? AND status = 'RESERVED'
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 2. 更新预留  │  CAS UPDATE status = 'CONFIRMED'
    │   状态       │  WHERE status = 'RESERVED' AND version = ?
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 3. 更新DB库存│  CAS UPDATE t_inventory
    │              │  reserved -= qty (预留转为实际扣减)
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 4. 记录流水  │  INSERT t_inventory_txn (reason=CONFIRM)
    └──────────────┘
```

## 4. 库存释放流程 (Release)

```
    OrderCanceled Event / Timeout
           │
           ▼
    ┌──────────────┐
    │ 1. 查询预留  │  SELECT * FROM t_inventory_reservation
    │   记录       │  WHERE order_no = ? AND status = 'RESERVED'
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 2. 更新预留  │  CAS UPDATE status = 'RELEASED'
    │   状态       │  WHERE status = 'RESERVED' AND version = ?
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────┐
    │ 3. Redis Lua 归还库存                                         │
    │                                                               │
    │   ┌─────────────────────────────────────────────────────┐    │
    │   │ -- 检查幂等标记是否存在                               │    │
    │   │ reservedQty = GET(KEYS[2])                           │    │
    │   │ if not reservedQty then return -1 end                │    │
    │   │                                                       │    │
    │   │ -- 归还库存                                           │    │
    │   │ available = GET(KEYS[1])                              │    │
    │   │ SET(KEYS[1], available + qty)                         │    │
    │   │                                                       │    │
    │   │ -- 删除幂等标记                                       │    │
    │   │ DEL(KEYS[2])                                          │    │
    │   │                                                       │    │
    │   │ return newAvailable                                   │    │
    │   └─────────────────────────────────────────────────────┘    │
    └──────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐
    │ 4. 更新DB库存│  CAS UPDATE t_inventory
    │              │  available += qty, reserved -= qty
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 5. 记录流水  │  INSERT t_inventory_txn (reason=RELEASE)
    └──────────────┘
```

## 5. 幂等策略说明

### 5.1 MQ消费幂等

```
┌─────────────────────────────────────────────────────────────────┐
│                    MQ Consume Idempotency                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  t_mq_consume_log 表结构:                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ event_id (UK) │ consumer_group (UK) │ status │ result   │    │
│  ├───────────────┼─────────────────────┼────────┼──────────┤    │
│  │ evt_001       │ inventory-group     │SUCCESS │ OK       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  流程:                                                           │
│  1. 消费前: INSERT ... ON DUPLICATE KEY 获取锁                   │
│  2. 如果已存在且status=SUCCESS, 直接返回(幂等)                   │
│  3. 如果已存在且status=PROCESSING, 抛异常触发重试                │
│  4. 消费成功后: UPDATE status=SUCCESS                            │
│  5. 消费失败后: UPDATE status=FAILED                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Redis Lua幂等

```
┌─────────────────────────────────────────────────────────────────┐
│                    Redis Lua Idempotency                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  幂等标记Key: inv:reserved:{orderNo}:{warehouseId}:{skuId}      │
│  过期时间: 24小时                                                │
│                                                                  │
│  预留时:                                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ if EXISTS(幂等标记) then                                 │    │
│  │     return 0  -- 已预留,幂等返回                         │    │
│  │ end                                                       │    │
│  │ -- 扣减库存                                               │    │
│  │ SETEX(幂等标记, 86400, qty)  -- 设置幂等标记             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  释放时:                                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ if not EXISTS(幂等标记) then                             │    │
│  │     return -1  -- 已释放或未预留,幂等返回                │    │
│  │ end                                                       │    │
│  │ -- 归还库存                                               │    │
│  │ DEL(幂等标记)  -- 删除幂等标记                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 DB唯一约束幂等

```
┌─────────────────────────────────────────────────────────────────┐
│                    DB Unique Constraint Idempotency              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  t_inventory_reservation 唯一约束:                               │
│  UNIQUE KEY uk_order_sku_warehouse (order_no, sku_id, warehouse_id)│
│                                                                  │
│  同一订单对同一SKU在同一仓库只能有一条预留记录                   │
│  重复插入会触发 DuplicateKeyException, 捕获后幂等返回            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 6. 超时释放流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Reservation Timeout Release                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  定时任务 (每分钟执行):                                          │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 1. 查询过期预留                                          │    │
│  │    SELECT * FROM t_inventory_reservation                 │    │
│  │    WHERE status = 'RESERVED'                             │    │
│  │    AND expire_at < NOW()                                 │    │
│  │    LIMIT 100                                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                         │                                        │
│                         ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 2. 检查是否应该释放                                      │    │
│  │    - 可扩展: 调用订单服务检查订单状态                    │    │
│  │    - 如果订单已支付, 应该确认而非释放                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                         │                                        │
│                         ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 3. 执行释放                                              │    │
│  │    inventoryService.releaseReservation(orderNo, reason) │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  注意事项:                                                       │
│  - 生产环境建议使用分布式调度(XXL-JOB)                          │
│  - 需要配合分布式锁防止多实例重复执行                           │
│  - 默认关闭, 需配置 inventory.reservation.timeout.enabled=true  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 7. 高并发防超卖原理

```
┌─────────────────────────────────────────────────────────────────┐
│                    High Concurrency Anti-Oversell                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  核心原理: Redis Lua 脚本原子性                                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │   并发请求 ──┬──▶ Redis Lua (原子执行)                   │    │
│  │              │                                           │    │
│  │   并发请求 ──┤    ┌─────────────────────────────┐       │    │
│  │              │    │ 1. 检查库存 available >= qty │       │    │
│  │   并发请求 ──┤    │ 2. 扣减库存 available -= qty │       │    │
│  │              │    │ 3. 设置幂等标记              │       │    │
│  │   并发请求 ──┘    └─────────────────────────────┘       │    │
│  │                                                          │    │
│  │   Lua脚本在Redis中串行执行, 保证原子性                   │    │
│  │   即使1000个并发请求, 也不会超卖                         │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  性能优势:                                                       │
│  - Redis单线程模型, Lua脚本原子执行                             │
│  - 无需分布式锁, 无锁竞争开销                                   │
│  - 单机Redis可支撑10万+ QPS                                     │
│                                                                  │
│  数据一致性:                                                     │
│  - Redis作为库存控制主节点                                      │
│  - MySQL作为持久化存储                                          │
│  - 通过对账任务保证最终一致性                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```
