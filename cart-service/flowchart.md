# 购物车与下单流程图

## 1. 加购流程 (Add to Cart)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              加购流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  用户    │
    └────┬─────┘
         │ POST /cart/items
         │ {skuId, qty, title, unitPrice, ...}
         ▼
    ┌──────────────┐
    │ CartController│
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐     解析用户身份
    │ CartService  │◄─── X-User-Id (登录用户)
    └──────┬───────┘     X-Anon-Id (游客)
           │
           │ 确定购物车Key
           │ - 登录用户: cart:{userId}
           │ - 游客用户: cart:anon:{anonId}
           ▼
    ┌──────────────────┐
    │ CartRedisService │
    └──────┬───────────┘
           │
           │ 1. 检查购物车商品数量限制 (max: 100)
           │ 2. 查询SKU是否已存在
           ▼
      ┌────┴────┐
      │ 已存在? │
      └────┬────┘
           │
     ┌─────┴─────┐
     │           │
    Yes         No
     │           │
     ▼           ▼
  ┌─────────┐  ┌─────────┐
  │数量累加  │  │新增商品  │
  │(上限99) │  │checked=T│
  └────┬────┘  └────┬────┘
       │            │
       └─────┬──────┘
             │
             ▼
    ┌─────────────────┐
    │ HSET cart:{key} │
    │ {skuId} {json}  │
    └────────┬────────┘
             │
             │ 刷新过期时间 (30天)
             ▼
    ┌─────────────────┐
    │ 返回购物车列表   │
    └─────────────────┘
```

## 2. 购物车合并流程 (Merge Cart)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           购物车合并流程                                     │
│                    (用户登录后，游客车 → 登录车)                             │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │ 用户登录  │
    └────┬─────┘
         │ POST /cart/merge
         │ {anonId, mergeStrategy}
         ▼
    ┌──────────────┐
    │ CartService  │
    │ mergeCart()  │
    └──────┬───────┘
           │
           │ 1. 获取游客购物车
           │    HGETALL cart:anon:{anonId}
           │
           │ 2. 获取用户购           │    HGETALL cart:{userId}
           ▼
      ┌────────────┐
      │ 游客车为空? │
      └─────┬──────┘
            │
      ┌─────┴─────┐
     Yes         No
      │           │
      ▼           ▼
  ┌────────┐  ┌─────────────────────────────────────┐
  │直接返回 │  │ 遍历游客车商品，检查是否冲突         │
  │用户车  │  └──────────────┬──────────────────────┘
  └────────┘                 │
                             ▼
                    ┌────────────────┐
                    │ 同SKU存在冲突?  │
                    └───────┬────────┘
                            │
                    ┌───────┴───────┐
                   Yes             No
                    │               │
            ┌───────┴───────┐       │
            │               │       │
    ┌───────▼───────┐ ┌─────▼─────┐ │
    │ QTY_ADD策略   │ │LATEST_WIN │ │
    │ 数量累加      │ │ 策略      │ │
    │ (上限99)     │ │以最新为准  │ │
    └───────┬───────┘ └─────┬─────┘ │
            │               │       │
            └───────┬───────┘       │
                    │               │
                    │    ┌──────────┘
                    │    │ 直接添加到用户车
                    ▼    ▼
           ┌─────────────────────┐
           │ 保存合并后的购物车   │
           │ DEL + HSET cart:{u} │
           └──────────┬──────────┘
                      │
                      ▼
           ┌─────────────────────┐
           │ 清空游客购物车       │
           │ DEL cart:anon:{a}   │
           └──────────┬──────────┘
                      │
                      ▼
           ┌─────────────────────┐
           │ 记录合并日志         │
           │ INSERT t_cart_merge │
           │ _log                │
           └──────────┬──────────┘
                      │
                      ▼
           ┌─────────────────────┐
           │ 返回合并后购物车     │
           └─────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 合并策略说明:                                                                │
│                                                                             │
│ 1. QTY_ADD (数量累加) - 默认策略                                            │
│    - 同SKU时，数量相加，上限99                                   │
│    - 价格使用游客车的最新价格                                                │
│                                                                             │
│ 2. LATEST_WIN (以最新为准)                                                  │
│    - 同SKU时，比较updatedAt时间戳                                           │
│    - 使用更新时间较新的商品数据                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 结算流程 (Checkout)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              结算流程                                        │
│                   (库存校验 + 促销计算 + 锁价)                               │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  用户    │
    └────┬─────┘
         │ POST /cart/checkout
         │ {skuIds?, userCouponNos?, lockMinutes?}
         ▼
    ┌──────────────┐
    │ CartService  │
    │ checkout()   │
    └──────┬───────┘
           │
           │ 1. 获取要结算的商品
           │    - 指定skuIds 或 所有checked=true的商品
           ▼
    ┌──────────────────┐
    │ 结算商品为空?     │
    └────────┬─────────┘
             │
       ┌─────┴─────┐
      Yes         No
       │           │
       ▼           ▼
   ┌────────┐  ┌─────────────────────────────────────┐
   │抛出异常 │  │ 2. 调用库存服务校验                  │
   │没有可结 │  │    InventoryClient.queryAvailable   │
   │算商品   │  │    Stock()                          │
   └────────┘  └──────────────┬──────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 所有库存充足?    │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                   Yes               No
                    │                 │
                    │                 ▼
                    │         ┌───────────────┐
                    │         │ 返回失败结果   │
                    │         │ canOrder=fal             │         │ 部分商品库存  │
                    │         │ 不足          │
                    │         └───────────────┘
                    ▼
           ┌─────────────────────────────────────┐
           │ 3. 调用定价服务锁价                  │
           │    PricingClient.lock()             │
           │    - 计算促销优惠                    │
           │    - 生成价格锁编号                  │
           │    - 生成签名(SHA256)               │
           │    - 锁定优惠券                      │
           └──────────────┬──────────────────────┘
                          │
                          ▼
                ┌─────────────────┐
                │ 锁价成功?       │
                └────────┬────────┘
                         │
                ┌────────┴────────┐
               Yes               No
                │                 │
                │                 ▼
                │         ┌───────────────┐
                │         │ 返回失败结果   │
                │         │ canOrder=false│
                │         │ 锁价失败原因  │
                │         └───────────────┘
                ▼
       ┌─────────────────────────────────────┐
       │ 4. 返回结算结果                      │
       │    - canOrder: true                 │
       │    - priceLockNo: PL20240101...     │
       │    - signature: sha256(...)         │
       │    - expireAt: 15分钟后             │
       │    - originalAmount: 原价           │
       │    - totalDiscount: 优惠总额        │
       │    - payableAmount: 应付金额        │
       │    - items: 商品明细(含分摊)        │
       │    - promotionHits: 命中的促销      │
       │    - stockCheckResults: 库存校验    │
       └─────────────────────────────────────┘
```

## 4. 下单流程 (Create Order with Price Lock)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           下单流程 (防篡价)                                  │
│                    订单创建必须基于锁价结果                                  │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  用户    │
    └────┬─────┘
         │ POST /orders
         │ {
         │   clientRequestId,
         │   userId,
         │   priceLockNo,      ◄── 必填！结算时获取
         │   signature,        ◄── 必填！防篡改签名
         │   items: [...]
         │ }
         ▼
    ┌───────────────┐
    │ OrderController│
    └───────┬───────┘
            │
            │ @Idempotent (clientRequestId)
            │ @RateLimit (500 QPS)
            ▼
    ┌───────────────┐
    │ OrderService  │
    │ createOrder() │
    └───────┬───────┘
            │
            │ 1. 幂等检查
            │    查询 userId + clientRequestId
            ▼
      ┌─────────────┐
      │ 订单已存在?  │
      └──────┬──────┘
             │
       ┌─────┴─────┐
      Yes         No
       │           │
       ▼           │
   ┌────────┐      │
   │返回已有 │      │
   │订单    │      │
   └────────┘      │
                   ▼
          ┌─────────────────────────────────────┐
          │ 2. 生成订单号                        │
          │    ORD + yyyyMMddHHmmssSSS + 4位随机 │
          └──────────────┬──────────────────────┘
                         │
                         ▼
          ┌─────────────────────────────────────┐
          │ 3. 调用定价服务使用价格锁            │
          │    POST /pricing/lock/{no}/use      │
          │    ?orderNo=xxx&signature=xxx       │
          └──────────────┬──────────────────────┘
                         │
                         ▼
               ┌─────────────────┐
               │ 价格锁校验成功?  │
               └────────┬────────┘
                        │
               ┌────────┴────────┐
              Yes               No
               │                 │
               │                 ▼
               │         ┌───────────────────┐
               │         │ 抛出异常           │
               │         │ - 签名验证失败     │
               │         │ - 价格锁已过期     │
               │         │ - 价格锁已使用     │
               │         │ - 用户ID不匹配     │
               │         └───────────────────┘
               ▼
          ┌─────────────────────────────────────┐
          │ 4. 校验商品明细                      │
          │    - SKU是否在锁价快照中             │
          │    - 数量是否匹配                    │
          │    - 商品数量是否一致                │
          └──────────────┬──────────────────────┘
                         │
                         ▼
          ┌─────────────────────────────────────┐
          │ 5. 创建订单 (使用锁价金额)           │
          │    - amount = priceLock.payableAmount│
          │    - 商品价格使用锁价快照            │
          │    - 记录priceLockNo                │
          └──────────────┬──────────────────────┘
                         │
                         ▼
          ┌─────────────────────────────────────┐
          │ 6. 保存订单明细                      │
          │    - priceSnapshot = 锁价单价        │
          │    - discountAmount = 分摊优惠       │
          │    - payableAmount = 分摊实付        │
          └──────────────┬──────────────────────┘
                         │
                         ▼
          ┌─────────────────────────────────────┐
          │ 7. 写Outbox事件                      │
          │    OrderCreatedEvent                │
          └──────────────┬──────────────────────┘
                         │
                         ▼
          ┌─────────────────────────────────────┐
          │ 8. 记录状态流转                      │
          │    CREATED (锁价:PL...)             │
          └──────────────┬──────────────────────┘
                         │
                         ▼
          ┌─────────────────────────────────────┐
          │ 返回订单信息                         │
          │ {orderNo, amount, priceLockNo, ...} │
          └─────────────────────────────────────┘
```

## 5. 完整购物流程时序图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           完整购物流程时序图                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  用户        cart-service      Redis       pricing-service    inventory-service    order-service
   │               │              │               │                   │                  │
   │ ① 加购商品    │              │               │                   │                  │
   │──────────────>│              │               │                   │                  │
   │               │ HSET cart:x  │               │                   │                  │
   │               │─────────────>│               │                   │                  │
   │               │<─────────────│               │                   │                  │
   │<──────────────│              │               │                   │                  │
   │               │              │               │                   │                  │
   │ ② 登录合并    │              │               │                   │                  │
   │──────────────>│              │               │                   │                  │
   │               │ HGETALL x2   │               │                   │                  │
   │               │─────────────>│               │                   │                  │
   │               │<─────────────│               │                   │                  │
   │               │ 合并 + 记录日志               │                   │                  │
   │<──────────────│              │               │                   │                  │
   │               │              │               │                   │                  │
   │ ③ 结算       │              │               │                   │                  │
   │──────────────>│              │               │                   │                  │
   │               │              │               │ 查询库存          │                  │
   │               │──────────────────────────────────────────────────>│                  │
   │               │<──────────────────────────────────────────────────│                  │
   │               │              │               │                   │                  │
   │               │              │ 锁价          │                   │                  │
   │               │─────────────────────────────>│                   │                  │
   │               │              │               │ 锁定优惠券        │                  │
   │               │              │               │ 生成签名          │                  │
   │               │<─────────────────────────────│                   │                  │
   │<──────────────│              │               │                   │                  │
   │  {priceLockNo, signature, payableAmount, ...}                    │                  │
   │               │              │               │                   │                  │
   │ ④ 下单       │              │               │                   │                  │
   │─────────────────────────────────────────────────────────────────────────────────────>│
   │               │              │               │                   │                  │
   │               │              │               │ 使用价格锁        │                  │
   │               │              │               │<─────────────────────────────────────│
   │               │              │               │ 验证签名          │                  │
   │               │              │               │ 标记已使用        │                  │
   │               │              │               │─────────────────────────────────────>│
   │               │              │               │                   │                  │
   │               │              │               │                   │ 创建订单         │
   │               │              │               │                   │ (使用锁价金额)   │
   │               │              │               │                   │                  │
   │               │              │               │                   │ 写Outbox事件     │
   │               │              │               │                   │                  │
   │<─────────────────────────────────────────────────────────────────────────────────────│
   │  {orderNo, amount, priceLockNo, ...}         │                   │                  │
   │               │              │               │                   │                  │
```

## 6. 防篡价机制说明

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           防篡价机制                                         │
└─────────────────────────────────────────────────────────────────────────────┘

1. 锁价签名生成 (pricing-service)
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ signature = SHA256(                                                     │
   │     priceLockNo + "|" +                                                 │
   │     userId + "|" +                                                      │
   │     payableAmount + "|" +                                               │
   │     snapshotJson + "|" +                                                │
   │     secretKey                                                           │
   │ )                                                                       │
   └─────────────────────────────────────────────────────────────────────────┘

2. 下单校验流程 (order-service)
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ ① 调用 pricing-service 使用价格锁                                       │
   │    POST /pricing/lock/{priceLockNo}/use?orderNo=xxx&signature=xxx       │
   │                                                                         │
   │ ② pricing-service 校验:                                                 │
   │    - 签名是否匹配                                                        │
   │    - 价格锁状态是否为 LOCKED                                             │
   │    - 是否已过期                                                          │
   │                                                                         │
   │ ③ 校验通过后:                                                           │
   │    - CAS更新状态为 USED                                                  │
   │    - 记录使用的订单号                                                    │
   │    - 返回锁价快照                                                        │
   │                                                                         │
   │ ④ order-service 使用锁价快照中的金额创建订单                            │
   │    - 订单金额 = priceLock.payableAmount                                 │
   │    - 商品单价 = allocation.unitPrice                                    │
   │    - 分摊优惠 = allocation.lineDiscountAmount                           │
   └─────────────────────────────────────────────────────────────────────────┘

3. 安全保障
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ ✓ 签名防篡改: 任何金额/商品修改都会导致签名验证失败                       │
   │ ✓ 一次性使用: 价格锁使用后状态变为USED，无法重复使用                      │
   │ ✓ 时效性: 价格锁有过期时间，过期后无法使用                               │
   │ ✓ 用户绑定: 价格锁与用户ID绑定，其他用户无法使用                         │
   │ ✓ 商品校验: 下单时校验商品SKU和数量是否与锁价快照一致                    │
   └─────────────────────────────────────────────────────────────────────────┘
```

## 7. Redis Key 设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Redis Key 设计                                     │
└─────────────────────────────────────────────────────────────────────────────┘

购物车存储:
┌─────────────────────────────────────────────────────────────────────────────┐
│ Key Pattern          │ Type │ Description                                   │
├──────────────────────┼──────┼───────────────────────────────────────────────┤
│ cart:{userId}        │ Hash │ 登录用户购物车                                │
│                      │      │ Field: skuId                                  │
│                      │      │ Value: CartItem JSON                          │
├──────────────────────┼──────┼───────────────────────────────────────────────┤
│ cart:anon:{anonId}   │ Hash │ 游客购物车                                    │
│                      │      │ Field: skuId                                  │
│                      │      │ Value: CartItem JSON                          │
├──────────────────────┼──────┼───────────────────────────────────────────────┤
│ TTL                  │      │ 30天                                          │
└─────────────────────────────────────────────────────────────────────────────┘

CartItem JSON 结构:
┌─────────────────────────────────────────────────────────────────────────────┐
│ {                                                                           │
│   "skuId": 10001,                                                           │
│   "spuId": 1001,                                                            │
│   "title": "商品标题",                                                       │
│   "imageUrl": "https://...",                                                │
│   "unitPrice": 99.00,                                                       │
│   "qty": 2,                                                                 │
│   "checked": true,                                                          │
│   "skuAttrs": "颜色:红色;尺码:XL",                                           │
│   "categoryId": 100,                                                        │
│   "warehouseId": 1,                                                         │
│   "addedAt": "2024-01-01T10:00:00",                                         │
│   "updatedAt": "2024-01-01T12:00:00"                                        │
│ }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```
