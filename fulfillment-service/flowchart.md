# 履约服务流程图

## 整体履约链路

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              履约链路流程图                                           │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐    PaymentSucceeded     ┌──────────────────┐
│              │ ─────────────────────▶  │                  │
│ payment-     │      (PAYMENT_TOPIC)    │  fulfillment-    │
│ service      │                         │  service         │
│              │                         │                  │
└──────────────┘                         └────────┬─────────┘
                                                  │
                                                  │ 自动创建发货单
                                                  ▼
                                         ┌──────────────────┐
                                         │   t_shipment     │
                                         │  status=CREATED  │
                                         └────────┬─────────┘
                                                  │
                                                  │ 发布 ShipmentCreated
                                                  ▼
┌──────────────┐    ShipmentShipped      ┌──────────────────┐
│              │ ◀─────────────────────  │                  │
│ order-       │    (FULFILLMENT_TOPIC)  │  调用发货接口     │
│ service      │                         │  POST /ship      │
│              │                         │                  │
│ PAID→SHIPPED│                         └────────┬─────────┘
└──────────────┘                                  │
       │                                          │ 创建运单 + 更新状态
       │                                          ▼
       │                                 ┌──────────────────┐
       │                                 │   t_shipment     │
       │                                 │  status=SHIPPED  │
       │                                 │   t_waybill      │
       │                                 └────────┬─────────┘
       │                                          │
       │                                          │ 发布 ShipmentShipped
       │                                          ▼
       │         ShipmentDelivered       ┌──────────────────┐
       │ ◀─────────────────────────────  │                  │
       │        (FULFILLMENT_TOPIC)      │  调用签收接口     │
       │                                 │  POST /deliver   │
       │                                 │                  │
       ▼                                 └────────┬─────────┘
┌──────────────┐                                  │
│ order-       │                                  │ 更新状态
│ service      │                                  ▼
│              │                         ┌──────────────────┐
│ SHIPPED→     │                         │   t_shipment     │
│ DELIVERED    │                         │ status=DELIVERED │
└──────────────┘                         └──────────────────┘
```

## 订单状态机

```
                    ┌─────────────────────────────────────────────────────┐
                    │                  订单状态机                          │
                    └─────────────────────────────────────────────────────┘

                                    ┌─────────┐
                                    │ CREATED │
                                    └────┬────┘
                                         │
                    ┌────────────────────┼────────────────────┐
                    │                    │                    │
                    ▼                    ▼                    ▼
            ┌──────────────┐    ┌──────────────┐      ┌──────────┐
            │ STOCK_FAILED │    │STOCK_RESERVED│      │ CANCELED │
            │   (终态)     │    └──────┬───────┘      │  (终态)  │
            └──────────────┘           │              └──────────┘
                                       │
                          ┌────────────┼────────────┐
                          │                         │
                          ▼                         ▼
                    ┌──────────┐              ┌──────────┐
                    │   PAID   │              │ CANCELED │
                    └────┬─────┘              │  (终态)  │
                         │                    └──────────┘
                         │ SHIP (发货)
                         ▼
                    ┌──────────┐
                    │ SHIPPED  │
                    └────┬─────┘
                         │ DELIVER (签收)
                         ▼
                    ┌──────────┐
                    │DELIVERED │
                    │  (终态)  │
                    └──────────┘
```

## 发货单状态机

```
                    ┌─────────────────────────────────────────────────────┐
                    │                 发货单状态机                          │
                    └─────────────────────────────────────────────────────┘

                    ┌─────────┐
                    │ CREATED │  ◀── 支付成功后自动创建
                    └────┬────┘
                         │
                         │ ship() 发货
                         │ 创建运单 t_waybill
                         ▼
                    ┌─────────┐
                    │ SHIPPED │
                    └────┬────┘
                         │
                         │ deliver() 签收
                         ▼
                    ┌──────────┐
                    │DELIVERED │  (终态)
                    └──────────┘
```

## MQ 事件流

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              MQ 事件流                                               │
└─────────────────────────────────────────────────────────────────────────────────────┘

Topic: PAYMENT_TOPIC
├── Tag: PAYMENT_SUCCEEDED
│   └── Publisher: payment-service
│   └── Consumer: order-service (STOCK_RESERVED → PAID)
│   └── Consumer: fulfillment-service (创建发货单)

Topic: FULFILLMENT_TOPIC
├── Tag: SHIPMENT_CREATED
│   └── Publisher: fulfillment-service
│   └── Consumer: (可扩展，如通知服务)
│
├── Tag: SHIPMENT_SHIPPED
│   └── Publisher: fulfillment-service
│   └── Consumer: order-service (PAID → SHIPPED)
│
└── Tag: SHIPMENT_DELIVERED
    └── Publisher: fulfillment-service
    └── Consumer: order-service (SHIPPED → DELIVERED)
```

## 物流轨迹乱序去重

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           物流轨迹乱序去重机制                                        │
└─────────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │        物流轨迹上报接口               │
                    │   POST /api/v1/logistics/track      │
                    └─────────────────┬───────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │     INSERT IGNORE INTO              │
                    │     t_logistics_track               │
                    │     (waybill_no, node_time,         │
                    │      node_code, content)            │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
            ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
            │  插入成功      │ │  重复被忽略    │ │  查询时排序    │
            │  (新轨迹)      │ │  (幂等)       │ │  ORDER BY     │
            │               │ │               │ │  node_time    │
            └───────────────┘ └───────────────┘ └───────────────┘

唯一约束: UNIQUE KEY `uk_waybill_node` (`waybill_no`, `node_time`, `node_code`)

特点:
1. 支持乱序写入 - 轨迹可以按任意顺序上报
2. 自动去重 - 相同 (waybill_no, node_time, node_code) 只保留一条
3. 查询有序 - 按 node_time 升序返回，保证时间线正确
```

## 数据模型

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              数据模型关系                                            │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐       1:1        ┌──────────────────┐
│    t_order       │ ◀──────────────▶ │   t_shipment     │
│                  │                  │                  │
│ order_no (UK)    │                  │ shipment_no (UK) │
│ status           │                  │ order_no (FK)    │
│ ...              │                  │ status           │
└──────────────────┘                  └────────┬─────────┘
                                               │
                                               │ 1:1
                                               ▼
                                      ┌──────────────────┐
                                      │   t_waybill      │
                                      │                  │
                                      │ waybill_no (UK)  │
                                      │ shipment_no (FK) │
                                      │ carrier          │
                                      └────────┬─────────┘
                                               │
                                               │ 1:N
                                               ▼
                                      ┌──────────────────┐
                                      │ t_logistics_track│
                                      │                  │
                                      │ waybill_no (FK)  │
                                      │ node_time        │
                                      │ node_code        │
                                      │ content          │
                                      └──────────────────┘
```

## 防乱序策略

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              防乱序策略                                              │
└─────────────────────────────────────────────────────────────────────────────────────┘

1. CAS 更新
   ┌─────────────────────────────────────────────────────────────────┐
   │ UPDATE t_order SET status = 'SHIPPED'                          │
   │ WHERE order_no = ? AND status = 'PAID'                         │
   │                                                                 │
   │ 只有当前状态是 PAID 时才能更新为 SHIPPED                          │
   │ 如果已经是 SHIPPED/DELIVERED，更新失败，标记为 IGNORED            │
   └─────────────────────────────────────────────────────────────────┘

2. 状态机校验
   ┌─────────────────────────────────────────────────────────────────┐
   │ if (!orderStateMachine.canTransition(currentStatus, event)) {  │
   │     // 记录为 IGNORED，不抛异常                                  │
   │     saveIgnoredStateFlow(...)                                   │
   │ }                                                               │
   └─────────────────────────────────────────────────────────────────┘

3. 幂等消费
   ┌─────────────────────────────────────────────────────────────────┐
   │ t_mq_consume_log 表                                             │
   │ UNIQUE KEY (event_id, consumer_group)                          │
   │                                                                 │
   │ 状态: PROCESSING → SUCCESS / FAILED / IGNORED                   │
   └─────────────────────────────────────────────────────────────────┘
```
