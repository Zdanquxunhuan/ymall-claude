# Product Service 流程图

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Product Service                                   │
│                                                                              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │ ProductController│───▶│  ProductService │───▶│   Repository    │         │
│  │   (REST API)    │    │  (Business Logic)│    │  (SPU/SKU/Outbox)│        │
│  └─────────────────┘    └────────┬────────┘    └────────┬────────┘         │
│                                  │                      │                   │
│                                  │                      ▼                   │
│                                  │             ┌───────────────┐            │
│                                  │             │   MySQL DB    │            │
│                                  │             │ t_spu, t_sku  │            │
│                                  │             │ t_outbox      │            │
│                                  │             └───────────────┘            │
│                                  │                      ▲                   │
│                                  │                      │                   │
│                          ┌───────▼───────┐              │                   │
│                          │ OutboxRelay   │──────────────┘                   │
│                          │   Worker      │                                  │
│                          └───────┬───────┘                                  │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
                        ┌─────────────────────┐
                        │     RocketMQ        │
                        │   PRODUCT_TOPIC:    │
                        │  PRODUCT_PUBLISHED  │
                        │  PRODUCT_UPDATED    │
                        │  PRODUCT_OFFLINE    │
                        └─────────────────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    ▼              ▼              ▼
            ┌───────────┐  ┌───────────┐  ┌───────────┐
            │ Inventory │  │  Search   │  │   Other   │
            │  Service  │  │  Service  │  │ Services  │
            └───────────┘  └───────────┘  └───────────┘
```

## 2. SPU/SKU 创建流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         SPU/SKU Creation Flow                                 │
└──────────────────────────────────────────────────────────────────────────────┘

    Client Request
           │
           ▼
    ┌──────────────┐
    │ POST /spu    │  创建SPU
    │ POST /sku    │  创建SKU
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 1. 参数校验  │  @Valid 注解校验
    │              │  - title 非空
    │              │  - categoryId 非空
    │              │  - price > 0
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 2. 业务校验  │  检查关联数据
    │              │  - SPU是否存在（创建SKU时）
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 3. 创建实体  │  设置初始状态
    │              │  status = DRAFT
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 4. 持久化    │  INSERT INTO t_spu/t_sku
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 5. 返回响应  │  SpuResponse / SkuResponse
    └──────────────┘
```

## 3. SKU 发布流程（核心）

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         SKU Publish Flow (Outbox Pattern)                     │
└──────────────────────────────────────────────────────────────────────────────┘

    POST /sku/{skuId}/publish
           │
           ▼
    ┌──────────────┐
    │ 1. 查询SKU   │  SELECT * FROM t_sku WHERE sku_id = ?
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 2. 状态检查  │  当前状态必须是 DRAFT 或 OFFLINE
    │              │  才允许发布
    └──────┬───────┘
           │ 状态合法
           ▼
    ┌──────────────────────────────────────────────────────────────┐
    │ 3. 事务开始 (@Transactional)                                  │
    │                                                               │
    │   ┌─────────────────────────────────────────────────────┐    │
    │   │ 3.1 更新SKU状态                                      │    │
    │   │     UPDATE t_sku SET status='PUBLISHED',            │    │
    │   │     publish_time=NOW() WHERE sku_id=?               │    │
    │   └─────────────────────────────────────────────────────┘    │
    │                         │                                     │
    │                         ▼                                     │
    │   ┌─────────────────────────────────────────────────────┐    │
    │   │ 3.2 更新SPU状态（如果是草稿）                        │    │
    │   │     UPDATE t_spu SET status='PUBLISHED'             │    │
    │   │     WHERE spu_id=? AND status='DRAFT'               │    │
    │   └─────────────────────────────────────────────────────┘    │
    │                         │                                     │
    │                         ▼                                     │
    │   ┌─────────────────────────────────────────────────────┐    │
    │   │ 3.3 创建发布事件                                     │    │
    │   │     ProductPublishedEvent {                         │    │
    │   │       eventId: UUID,                                │    │
    │   │       eventType: "PRODUCT_PUBLISHED",               │    │
    │   │       version: "1.0",                               │    │
    │   │       skuId, spuId, title, price, ...               │    │
    │   │     }                                               │    │
    │   └─────────────────────────────────────────────────────┘    │
    │                         │                                     │
    │                         ▼                                     │
    │   ┌─────────────────────────────────────────────────────┐    │
    │   │ 3.4 写入Outbox表                                     │    │
    │   │     INSERT INTO t_outbox (                          │    │
    │   │       event_id, event_type, aggregate_type,         │    │
    │   │       aggregate_id, payload, status                 │    │
    │   │     ) VALUES (?, 'PRODUCT_PUBLISHED', 'SKU',        │    │
    │   │       ?, ?, 'PENDING')                              │    │
    │   └─────────────────────────────────────────────────────┘    │
    │                                                               │
    │ 4. 事务提交                                                   │
    └──────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐
    │ 5. 返回响应  │  SkuResponse (status=PUBLISHED)
    └──────────────┘
```

## 4. Outbox Relay 流程（最终一致性）

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Outbox Relay Worker Flow                              │
└──────────────────────────────────────────────────────────────────────────────┘

    定时任务 (每秒执行)
           │
           ▼
    ┌──────────────────────────────────────────────────────────────┐
    │ 1. 查询待发送消息（带行锁）                                    │
    │                                                               │
    │    SELECT * FROM t_outbox                                     │
    │    WHERE status = 'PENDING'                                   │
    │    AND (next_retry_at IS NULL OR next_retry_at <= NOW())     │
    │    ORDER BY created_at ASC                                    │
    │    LIMIT 100                                                  │
    │    FOR UPDATE SKIP LOCKED                                     │
    │                                                               │
    │    注: FOR UPDATE SKIP LOCKED 防止多实例重复处理              │
    └──────────────────────────────────────────────────────────────┘
           │
           │ 遍历每条消息
           ▼
    ┌──────────────┐
    │ 2. 发送到MQ  │  producerTemplate.sendSync(
    │              │    PRODUCT_TOPIC,
    │              │    tag,
    │              │    eventId,
    │              │    payload
    │              │  )
    └──────┬───────┘
           │
           ├─────────────────────────────────────┐
           │ 成功                                 │ 失败
           ▼                                     ▼
    ┌──────────────┐                     ┌──────────────┐
    │ 3a. 标记已发送│                     │ 3b. 处理失败 │
    │              │                     │              │
    │ UPDATE t_outbox                    │ retryCount++│
    │ SET status='SENT'                  │              │
    │ WHERE id=?                         │ if (retryCount >= maxRetry)
    │ AND version=?                      │   status='FAILED'
    └──────────────┘                     │ else
                                         │   nextRetryAt = 指数退避
                                         │   status='FAILED'
                                         └──────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                    指数退避策略                                   │
    ├─────────────────────────────────────────────────────────────────┤
    │  重试次数  │  等待时间                                           │
    │     1     │  2^1 * 10 = 20秒                                    │
    │     2     │  2^2 * 10 = 40秒                                    │
    │     3     │  2^3 * 10 = 80秒 (超过maxRetry，标记FAILED)         │
    └─────────────────────────────────────────────────────────────────┘
```

## 5. 事件Schema定义

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Event Schema (version: 1.0)                           │
└──────────────────────────────────────────────────────────────────────────────┘

ProductPublishedEvent:
┌─────────────────────────────────────────────────────────────────┐
│ {                                                                │
│   "eventId": "abc123...",           // 事件唯一ID               │
│   "eventType": "PRODUCT_PUBLISHED", // 事件类型                 │
│   "version": "1.0",                 // Schema版本               │
│   "eventTime": "2024-01-01T12:00:00", // 事件时间               │
│   "source": "product-service",      // 事件来源                 │
│   "skuId": 1001,                    // SKU ID                   │
│   "spuId": 100,                     // SPU ID                   │
│   "title": "iPhone 15 黑色 256GB",  // SKU标题                  │
│   "attrsJson": "{\"颜色\":\"黑色\"}", // 销售属性               │
│   "price": 6999.00,                 // 销售价格                 │
│   "categoryId": 1001,               // 分类ID                   │
│   "brandId": 1,                     // 品牌ID                   │
│   "skuCode": "SKU001",              // SKU编码                  │
│   "publishTime": "2024-01-01T12:00:00" // 发布时间              │
│ }                                                                │
└─────────────────────────────────────────────────────────────────┘

ProductUpdatedEvent:
┌─────────────────────────────────────────────────────────────────┐
│ {                                                                │
│   "eventId": "def456...",           // 事件唯一ID               │
│   "eventType": "PRODUCT_UPDATED",   // 事件类型                 │
│   "version": "1.0",                 // Schema版本               │
│   "eventTime": "2024-01-01T13:00:00", // 事件时间               │
│   "source": "product-service",      // 事件来源                 │
│   "skuId": 1001,                    // SKU ID                   │
│   "spuId": 100,                     // SPU ID                   │
│   "title": "iPhone 15 黑色 256GB",  // SKU标题                  │
│   "attrsJson": "{\"颜色\":\"黑色\"}", // 销售属性               │
│   "price": 6499.00,                 // 更新后价格               │
│   "categoryId": 1001,               // 分类ID                   │
│   "brandId": 1,                     // 品牌ID                   │
│   "skuCode": "SKU001",              // SKU编码                  │
│   "status": "PUBLISHED",            // 当前状态                 │
│   "updatedFields": ["price"]        // 更新的字段列表           │
│ }                                                                │
└─────────────────────────────────────────────────────────────────┘
```

## 6. 最终一致性保证

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Eventual Consistency Guarantee                        │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                    Outbox Pattern 原理                           │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │  传统方式（有问题）:                                             │
    │  ┌─────────────┐    ┌─────────────┐                             │
    │  │ 1. 更新DB   │───▶│ 2. 发送MQ   │  ← 如果MQ发送失败，         │
    │  └─────────────┘    └─────────────┘    数据不一致！              │
    │                                                                  │
    │  Outbox Pattern:                                                 │
    │  ┌─────────────────────────────────────┐                        │
    │  │ 事务 {                               │                        │
    │  │   1. 更新业务表                      │                        │
    │  │   2. 写入Outbox表                    │  ← 同一事务，原子性    │
    │  │ }                                    │                        │
    │  └─────────────────────────────────────┘                        │
    │                    │                                             │
    │                    ▼                                             │
    │  ┌─────────────────────────────────────┐                        │
    │  │ Relay Worker (异步)                  │                        │
    │  │   1. 读取Outbox                      │                        │
    │  │   2. 发送MQ                          │  ← 失败可重试          │
    │  │   3. 更新Outbox状态                  │                        │
    │  └─────────────────────────────────────┘                        │
    │                                                                  │
    └─────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                    一致性保证机制                                 │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │  1. 事务原子性:                                                  │
    │     - 业务操作和Outbox写入在同一事务                            │
    │     - 要么都成功，要么都失败                                    │
    │                                                                  │
    │  2. 消息可靠投递:                                                │
    │     - Relay Worker 定时扫描                                     │
    │     - 失败自动重试（指数退避）                                  │
    │     - 最大重试次数限制                                          │
    │                                                                  │
    │  3. 幂等消费:                                                    │
    │     - 消费者根据 eventId 去重                                   │
    │     - 保证消息处理的幂等性                                      │
    │                                                                  │
    │  4. 并发控制:                                                    │
    │     - FOR UPDATE SKIP LOCKED 防止重复处理                       │
    │     - 乐观锁 version 防止并发更新                               │
    │                                                                  │
    └─────────────────────────────────────────────────────────────────┘
```

## 7. 状态机

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         SKU Status State Machine                              │
└──────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────┐
                    │  DRAFT  │  初始状态
                    └────┬────┘
                         │
                         │ publish()
                         ▼
                    ┌─────────┐
         ┌─────────│PUBLISHED│─────────┐
         │         └────┬────┘         │
         │              │              │
         │ update()     │ offline()   │ update()
         │              │              │
         │              ▼              │
         │         ┌─────────┐         │
         └────────▶│ OFFLINE │◀────────┘
                   └────┬────┘
                        │
                        │ publish()
                        ▼
                   ┌─────────┐
                   │PUBLISHED│
                   └─────────┘

    状态说明:
    ┌─────────┬────────────────────────────────────────────────────┐
    │  状态   │  说明                                               │
    ├─────────┼────────────────────────────────────────────────────┤
    │ DRAFT   │ 草稿状态，新创建的SKU                              │
    │ PENDING │ 待审核状态（预留，当前未使用）                     │
    │PUBLISHED│ 已发布/上架状态，可被用户查询和购买                │
    │ OFFLINE │ 已下架状态，不可被用户查询和购买                   │
    └─────────┴────────────────────────────────────────────────────┘
```

## 8. 下游消费示例

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Downstream Consumer Example                           │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                    库存服务消费示例                               │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │  @RocketMQMessageListener(                                       │
    │      topic = "PRODUCT_TOPIC",                                    │
    │      consumerGroup = "inventory-consumer-group",                 │
    │      selectorExpression = "PRODUCT_PUBLISHED"                    │
    │  )                                                               │
    │  public class ProductPublishedConsumer                           │
    │      implements RocketMQListener<String> {                       │
    │                                                                  │
    │      @Override                                                   │
    │      public void onMessage(String message) {                     │
    │          ProductPublishedEvent event = parse(message);          │
    │                                                                  │
    │          // 1. 幂等检查                                          │
    │          if (consumed(event.getEventId())) {                    │
    │              return;                                             │
    │          }                                                       │
    │                                                                  │
    │          // 2. 初始化库存记录                                    │
    │          inventoryService.initInventory(                        │
    │              event.getSkuId(),                                  │
    │              defaultWarehouseId,                                │
    │              0  // 初始库存为0                                   │
    │          );                                                      │
    │                                                                  │
    │          // 3. 标记已消费                                        │
    │          markConsumed(event.getEventId());                      │
    │      }                                                           │
    │  }                                                               │
    │                                                                  │
    └─────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                    搜索服务消费示例                               │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │  @RocketMQMessageListener(                                       │
    │      topic = "PRODUCT_TOPIC",                                    │
    │      consumerGroup = "search-consumer-group",                    │
    │      selectorExpression = "PRODUCT_PUBLISHED || PRODUCT_UPDATED"│
    │  )                                                               │
    │  public class ProductEventConsumer                               │
    │      implements RocketMQListener<String> {                       │
    │                                                                  │
    │      @Override                                                   │
    │      public void onMessage(String message) {                     │
    │          // 更新ES索引                                           │
    │          searchService.indexProduct(event);                     │
    │      }                                                           │
    │  }                                                               │
    │                                                                  │
    └─────────────────────────────────────────────────────────────────┘
```
