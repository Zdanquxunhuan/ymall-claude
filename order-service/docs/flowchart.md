# 订单服务流程图

## 1. 创建订单流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              创建订单流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Client  │────▶│  Controller  │────▶│ OrderService │────▶│   Database   │
└──────────┘     └──────────────┘     └──────────────┘     └──────────────┘
     │                  │                    │                    │
     │  POST /orders    │                    │                    │
     │  {clientRequestId│                    │                    │
     │   userId, items} │                    │                    │
     │                  │                    │                    │
     │                  ▼                    │                    │
     │           ┌─────────────┐             │                    │
     │           │ @Idempotent │             │                    │
     │           │ 幂等检查     │             │                    │
     │           │ (Redis)     │             │                    │
     │           └─────────────┘             │                    │
     │                  │                    │                    │
     │           ┌──────┴──────┐             │                    │
     │           │             │             │                    │
     │       首次请求      重复请求           │                    │
     │           │             │             │                    │
     │           ▼             ▼             │                    │
     │    ┌──────────┐  ┌─────────────┐      │                    │
     │    │ 继续处理  │  │ 返回缓存结果 │      │                    │
     │    └──────────┘  └─────────────┘      │                    │
     │           │                           │                    │
     │           ▼                           │                    │
     │    ┌──────────────────────────────────────────────────────────┐
     │    │                    @Transactional                        │
     │    │  ┌─────────────────────────────────────────────────────┐ │
     │    │  │ 1. 幂等检查 (DB层)                                   │ │
     │    │  │    SELECT * FROM t_order                            │ │
     │    │  │    WHERE user_id=? AND client_request_id=?          │ │
     │    │  └─────────────────────────────────────────────────────┘ │
     │    │                       │                                  │
     │    │              ┌───────┴───────┐                          │
     │    │              │               │                          │
     │    │          已存在           不存在                         │
     │    │              │               │                          │
     │    │              ▼               ▼                          │
     │    │       ┌──────────┐    ┌─────────────┐                   │
     │    │       │ 返回已有  │    │ 2. 生成订单号│                   │
     │    │       │ 订单     │    │ 3. 计算金额  │                   │
     │    │       └──────────┘    └─────────────┘                   │
     │    │                              │                          │
     │    │                              ▼                          │
     │    │                       ┌─────────────┐                   │
     │    │                       │ 4. INSERT   │                   │
     │    │                       │ t_order     │                   │
     │    │                       │ t_order_item│                   │
     │    │                       └─────────────┘                   │
     │    │                              │                          │
     │    │                              ▼                          │
     │    │                       ┌─────────────┐                   │
     │    │                       │ 5. INSERT   │                   │
     │    │                       │ t_outbox    │                   │
     │    │                       │ (OrderCreated)                  │
     │    │                       └─────────────┘                   │
     │    │                              │                          │
     │    │                              ▼                          │
     │    │                       ┌─────────────┐                   │
     │    │                       │ 6. INSERT   │                   │
     │    │                       │ t_order_    │                   │
     │    │                       │ state_flow  │                   │
     │    │                       └─────────────┘                   │
     │    │                              │                          │
     │    └──────────────────────────────┼──────────────────────────┘
     │                                   │ COMMIT
     │                                   ▼
     ◀───────────────────────────────────┘
     Response: {orderNo, status: CREATED}
```

## 2. 取消订单流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              取消订单流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Client  │────▶│  Controller  │────▶│ OrderService │────▶│   Database   │
└──────────┘     └──────────────┘     └──────────────┘     └──────────────┘
     │                  │                    │                    │
     │  POST /orders/   │                    │                    │
     │  {orderNo}/cancel│                    │                    │
     │  Header:         │                    │                    │
     │  X-Idempotency-Key                    │                    │
     │                  │                    │                    │
     │                  ▼                    │                    │
     │           ┌─────────────┐             │                    │
     │           │ @Idempotent │             │                    │
     │           │ 幂等检查     │             │                    │
     │           └─────────────┘             │                    │
     │                  │                    │                    │
     │                  ▼                    │                    │
     │    ┌──────────────────────────────────────────────────────────┐
     │    │                    @Transactional                        │
     │    │  ┌─────────────────────────────────────────────────────┐ │
     │    │  │ 1. 查询订单                                          │ │
     │    │  │    SELECT * FROM t_order WHERE order_no=?           │ │
     │    │  └─────────────────────────────────────────────────────┘ │
     │    │                       │                                  │
     │    │              ┌───────┴───────┐                          │
     │    │              │               │                          │
     │    │          不存在          存在                            │
     │    │              │               │                          │
     │    │              ▼               ▼                          │
     │    │       ┌──────────┐    ┌─────────────┐                   │
     │    │       │ 抛出异常  │    │ 2. 检查状态  │                   │
     │    │       │ NOT_FOUND│    │ 是否已取消?  │                   │
     │    │       └──────────┘    └─────────────┘                   │
     │    │                              │                          │
     │    │                       ┌──────┴──────┐                   │
     │    │                       │             │                   │
     │    │                   已取消         未取消                  │
     │    │                       │             │                   │
     │    │                       ▼             ▼                   │
     │    │                ┌──────────┐  ┌─────────────┐            │
     │    │                │ 幂等返回  │  │ 3. 状态机   │            │
     │    │                │ 已取消订单│  │ 校验        │            │
     │    │                └──────────┘  └─────────────┘            │
     │    │                                    │                    │
     │    │                             ┌──────┴──────┐             │
     │    │                             │             │             │
     │    │                         不允许         允许              │
     │    │                             │             │             │
     │    │                             ▼             ▼             │
     │    │                      ┌──────────┐  ┌─────────────┐      │
     │    │                      │ 抛出异常  │  │ 4. CAS更新  │      │
     │    │                      │ STATE_   │  │ status      │      │
     │    │                      │ INVALID  │  │ version+1   │      │
     │    │                      └──────────┘  └─────────────┘      │
     │    │                                          │              │
     │    │                                   ┌──────┴──────┐       │
     │    │                                   │             │       │
     │    │                               CAS失败       CAS成功     │
     │    │                                   │             │       │
     │    │                                   ▼             ▼       │
     │    │                            ┌──────────┐  ┌─────────────┐│
     │    │                            │ 重新查询  │  │ 5. INSERT  ││
     │    │                            │ 判断状态  │  │ t_outbox   ││
     │    │                            └──────────┘  │(OrderCanceled)│
     │    │                                          └─────────────┘│
     │    │                                                │        │
     │    │                                                ▼        │
     │    │                                         ┌─────────────┐ │
     │    │                                         │ 6. INSERT   │ │
     │    │                                         │ t_order_    │ │
     │    │                                         │ state_flow  │ │
     │    │                                         └─────────────┘ │
     │    │                                                │        │
     │    └────────────────────────────────────────────────┼────────┘
     │                                                     │ COMMIT
     │                                                     ▼
     ◀─────────────────────────────────────────────────────┘
     Response: {orderNo, status: CANCELED}
```

## 3. 订单状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              订单状态机 (V2)                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │             │
                    CREATE    │   CREATED   │
              ───────────────▶│             │
                              │  (已创建)    │
                              └──────┬──────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    │ STOCK_RESERVED │ STOCK_RESERVE  │ CANCEL
                    │                │ _FAILED        │
                    ▼                ▼                ▼
             ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
             │   STOCK_    │  │   STOCK_    │  │             │
             │  RESERVED   │  │   FAILED    │  │  CANCELED   │
             │             │  │             │  │             │
             │ (库存已预留) │  │(库存预留失败)│  │  (已取消)    │
             └──────┬──────┘  └─────────────┘  └─────────────┘
                    │            [终态]           [终态]
                    │
                    │ CANCEL
                    │
                    ▼
             ┌─────────────┐
             │             │
             │  CANCELED   │
             │             │
             │  (已取消)    │
             └─────────────┘
                [终态]


状态转换表:
┌────────────────┬────────────────────┬────────────────┐
│ 当前状态        │ 事件               │ 目标状态        │
├────────────────┼────────────────────┼────────────────┤
│ (初始)         │ CREATE             │ CREATED        │
│ CREATED        │ STOCK_RESERVED     │ STOCK_RESERVED │
│ CREATED        │ STOCK_RESERVE_FAILED│ STOCK_FAILED   │
│ CREATED        │ CANCEL             │ CANCELED       │
│ STOCK_RESERVED │ CANCEL             │ CANCELED       │
│ STOCK_FAILED   │ -                  │ - (终态)       │
│ CANCELED       │ -                  │ - (终态)       │
└────────────────┴────────────────────┴────────────────┘

CAS更新SQL (防乱序):
UPDATE t_order 
SET status = #{toStatus}, 
    version = version + 1,
    updated_at = NOW()
WHERE order_no = #{orderNo} 
  AND status = #{fromStatus}   -- 仅检查状态，不检查版本
  AND deleted = 0
```

## 3.1 乱序处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           乱序消息处理流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │  收到库存事件    │
                    │ (StockReserved/ │
                    │ StockReserveFailed)│
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   幂等检查       │
                    │ t_mq_consume_log│
                    │ (event_id唯一)  │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                已处理              未处理
                    │                 │
                    ▼                 ▼
             ┌─────────────┐   ┌─────────────┐
             │ 直接返回     │   │ 插入消费日志 │
             │ (幂等)      │   │ status=     │
             │             │   │ PROCESSING  │
             └─────────────┘   └──────┬──────┘
                                      │
                                      ▼
                              ┌─────────────────┐
                              │   查询订单状态   │
                              └────────┬────────┘
                                       │
                              ┌────────┴────────┐
                              │                 │
                          订单不存在         订单存在
                              │                 │
                              ▼                 ▼
                       ┌─────────────┐   ┌─────────────────┐
                       │ 标记FAILED  │   │   状态机校验     │
                       │ 订单不存在   │   │ canTransition() │
                       └─────────────┘   └────────┬────────┘
                                                  │
                                         ┌────────┴────────┐
                                         │                 │
                                     不允许转换         允许转换
                                         │                 │
                                         ▼                 ▼
                                  ┌─────────────┐   ┌─────────────────┐
                                  │ 乱序消息     │   │   CAS更新状态    │
                                  │ 记录IGNORED │   │ WHERE status=   │
                                  │ state_flow  │   │ CREATED         │
                                  └─────────────┘   └────────┬────────┘
                                                             │
                                                    ┌────────┴────────┐
                                                    │                 │
                                                CAS失败           CAS成功
                                                    │                 │
                                                    ▼                 ▼
                                             ┌─────────────┐   ┌─────────────┐
                                             │ 乱序/并发    │   │ 记录状态流转 │
                                             │ 记录IGNORED │   │ 标记SUCCESS │
                                             │ state_flow  │   │             │
                                             └─────────────┘   └─────────────┘
```

## 3.2 乱序场景示例

```
场景1: StockReserved 先到达
─────────────────────────────────────────────────────────────────────────────
时间线:
T1: 订单创建 ──────────────────────────────────────────▶ CREATED
T2: 库存服务发送 StockReserveFailed (网络延迟)
T3: 库存服务发送 StockReserved (先到达)
T4: StockReserved 消费成功 ────────────────────────────▶ STOCK_RESERVED
T5: StockReserveFailed 到达 (乱序)
T6: 状态机校验失败，标记为 IGNORED ────────────────────▶ STOCK_RESERVED (不变)

最终状态: STOCK_RESERVED ✓


场景2: StockReserveFailed 先到达
─────────────────────────────────────────────────────────────────────────────
时间线:
T1: 订单创建 ──────────────────────────────────────────▶ CREATED
T2: 库存服务发送 StockReserved (网络延迟)
T3: 库存服务发送 StockReserveFailed (先到达)
T4: StockReserveFailed 消费成功 ───────────────────────▶ STOCK_FAILED
T5: StockReserved 到达 (乱序)
T6: 状态机校验失败，标记为 IGNORED ────────────────────▶ STOCK_FAILED (不变)

最终状态: STOCK_FAILED ✓


场景3: 重复消息
─────────────────────────────────────────────────────────────────────────────
时间线:
T1: 订单创建 ──────────────────────────────────────────▶ CREATED
T2: StockReserved 消费成功 ────────────────────────────▶ STOCK_RESERVED
T3: StockReserved 重复投递 (相同 eventId)
T4: 幂等检查发现已处理，直接返回 ──────────────────────▶ STOCK_RESERVED (不变)

最终状态: STOCK_RESERVED ✓
状态流转记录: 仅1条
```

## 3.3 消费状态说明

```
┌────────────┬────────────┬─────────────────────────────────────────────────┐
│ 状态       │ 编码       │ 说明                                            │
├────────────┼────────────┼─────────────────────────────────────────────────┤
│ 处理中     │ PROCESSING │ 消息正在处理，其他实例不应重复处理               │
│ 成功       │ SUCCESS    │ 消息处理成功，状态已更新                         │
│ 失败       │ FAILED     │ 消息处理失败，可能需要人工介入                   │
│ 已忽略     │ IGNORED    │ 乱序消息，已忽略但记录审计日志                   │
└────────────┴────────────┴─────────────────────────────────────────────────┘
```

## 4. Outbox 写入流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Outbox 写入流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

业务操作与事件写入在同一事务中:

┌─────────────────────────────────────────────────────────────────────────────┐
│                         @Transactional                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐          │  │
│  │   │ 1. 业务操作  │─────▶│ 2. 写Outbox │─────▶│ 3. 写StateFlow│         │  │
│  │   │ INSERT/UPDATE│      │ INSERT      │      │ INSERT      │          │  │
│  │   │ t_order     │      │ t_outbox    │      │ t_order_    │          │  │
│  │   │             │      │ _event      │      │ state_flow  │          │  │
│  │   └─────────────┘      └─────────────┘      └─────────────┘          │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│                               COMMIT                                        │
│                                    │                                        │
│                         ┌──────────┴──────────┐                            │
│                         │                     │                            │
│                      成功                   失败                            │
│                         │                     │                            │
│                         ▼                     ▼                            │
│                  ┌─────────────┐       ┌─────────────┐                     │
│                  │ 所有数据    │       │ 全部回滚    │                     │
│                  │ 一起提交    │       │ 保持一致    │                     │
│                  └─────────────┘       └─────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘


Outbox 表数据示例:
┌────────────────────────────────────────────────────────────────────────────┐
│ t_outbox_event                                                             │
├────────────────────────────────────────────────────────────────────────────┤
│ event_id: a1b2c3d4e5f6                                                     │
│ biz_key: ORD202401151030451234567                                          │
│ topic: ORDER_TOPIC                                                         │
│ tag: ORDER_CREATED                                                         │
│ payload_json: {"orderNo":"ORD...","userId":10001,"amount":299.98,...}     │
│ status: PENDING                                                            │
│ retry_count: 0                                                             │
│ trace_id: trace-123456789                                                  │
│ created_at: 2024-01-15 10:30:45                                           │
└────────────────────────────────────────────────────────────────────────────┘


Relay 投递流程 (后续实现):
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  Scheduler  │─────▶│ Query       │─────▶│ Send to MQ  │
│  定时任务    │      │ PENDING     │      │             │
│             │      │ Events      │      │             │
└─────────────┘      └─────────────┘      └──────┬──────┘
                                                 │
                                          ┌──────┴──────┐
                                          │             │
                                       成功           失败
                                          │             │
                                          ▼             ▼
                                   ┌─────────────┐ ┌─────────────┐
                                   │ UPDATE      │ │ UPDATE      │
                                   │ status=SENT │ │ retry_count │
                                   │ sent_at=NOW │ │ next_retry  │
                                   └─────────────┘ └─────────────┘
```

## 5. 幂等处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           幂等处理流程                                       │
└─────────────────────────────────────────────────────────────────────────────┘

创建订单幂等 (双重保障):

1. Redis层幂等 (@Idempotent注解):
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ Key: idempotent:order:create:{clientRequestId}                         │
   │ Value: {status: PROCESSING/SUCCESS, result: {...}}                     │
   │ TTL: 24小时                                                             │
   └─────────────────────────────────────────────────────────────────────────┘

2. DB层幂等 (唯一索引):
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ UNIQUE KEY `uk_user_client_request` (`user_id`, `client_request_id`)   │
   └─────────────────────────────────────────────────────────────────────────┘


取消订单幂等:

1. Redis层幂等:
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ Key: idempotent:order:cancel:{X-Idempotency-Key}                       │
   └─────────────────────────────────────────────────────────────────────────┘

2. 业务层幂等 (状态判断):
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ if (currentStatus == CANCELED) {                                       │
   │     return existingOrder;  // 幂等返回                                  │
   │ }                                                                       │
   └─────────────────────────────────────────────────────────────────────────┘


请求流程:
     Request 1                    Request 2 (重复)
         │                              │
         ▼                              ▼
    ┌─────────┐                    ┌─────────┐
    │ Redis   │                    │ Redis   │
    │ SETNX   │                    │ EXISTS  │
    │ 成功    │                    │ 存在    │
    └────┬────┘                    └────┬────┘
         │                              │
         ▼                              ▼
    ┌─────────┐                    ┌─────────┐
    │ 执行    │                    │ 返回    │
    │ 业务    │                    │ 缓存    │
    │ 逻辑    │                    │ 结果    │
    └────┬────┘                    └─────────┘
         │
         ▼
    ┌─────────┐
    │ 更新    │
    │ Redis   │
    │ 结果    │
    └─────────┘
```
