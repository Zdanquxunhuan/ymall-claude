# Payment Service 流程图

## 1. 支付回调幂等处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         支付回调幂等处理流程                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  接收回调请求  │
                              └──────┬───────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  生成回调唯一ID (callbackId)    │
                    │  = MD5(payNo + timestamp + nonce)│
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │     验证签名           │
                         │ MD5(params + secret)  │
                         └───────────┬───────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │                                  │
                    ▼                                  ▼
           ┌───────────────┐                 ┌───────────────┐
           │  签名验证失败   │                 │  签名验证成功   │
           └───────┬───────┘                 └───────┬───────┘
                   │                                  │
                   ▼                                  ▼
        ┌─────────────────────┐          ┌─────────────────────┐
        │ 记录回调日志         │          │ 查询 callbackId      │
        │ signature_valid=0   │          │ 是否已存在           │
        │ process_result=FAILED│          └──────────┬──────────┘
        └─────────────────────┘                      │
                                      ┌──────────────┴──────────────┐
                                      │                              │
                                      ▼                              ▼
                             ┌───────────────┐              ┌───────────────┐
                             │   已存在       │              │   不存在       │
                             │  (重复回调)    │              │  (首次回调)    │
                             └───────┬───────┘              └───────┬───────┘
                                     │                              │
                                     ▼                              ▼
                          ┌─────────────────┐           ┌─────────────────────┐
                          │ 返回 IGNORED    │           │ 查询支付单状态       │
                          │ "重复回调已忽略" │           └──────────┬──────────┘
                          └─────────────────┘                      │
                                                    ┌──────────────┴──────────────┐
                                                    │                              │
                                                    ▼                              ▼
                                         ┌─────────────────┐            ┌─────────────────┐
                                         │ 状态允许回调     │            │ 状态不允许回调   │
                                         │ (INIT/PAYING)   │            │ (已终态)         │
                                         └────────┬────────┘            └────────┬────────┘
                                                  │                              │
                                                  ▼                              ▼
                                    ┌──────────────────────┐         ┌─────────────────┐
                                    │ CAS 更新支付状态      │         │ 返回 IGNORED    │
                                    │ WHERE status IN      │         │ "状态不允许回调" │
                                    │ ('INIT','PAYING')    │         └─────────────────┘
                                    └──────────┬───────────┘
                                               │
                                ┌──────────────┴──────────────┐
                                │                              │
                                ▼                              ▼
                       ┌───────────────┐              ┌───────────────┐
                       │  更新成功      │              │  更新失败      │
                       └───────┬───────┘              │  (并发冲突)    │
                               │                      └───────┬───────┘
                               ▼                              │
                ┌──────────────────────────┐                  ▼
                │ 记录回调日志              │       ┌─────────────────┐
                │ process_result=PROCESSED │       │ 返回 IGNORED    │
                │ 发送 PaymentSucceeded    │       │ "并发更新已忽略" │
                └──────────────────────────┘       └─────────────────┘
```

## 2. 补单与对账流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           补单与对账流程                                      │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌────────────────────────┐
                         │  定时任务触发 (60s)     │
                         │  PaymentReconcileScheduler │
                         └───────────┬────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  扫描超时 PAYING 状态支付单     │
                    │  WHERE status='PAYING'         │
                    │  AND created_at < 超时阈值     │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  遍历每个超时支付单    │
                         └───────────┬───────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  模拟主动查单                   │
                    │  (实际调用第三方支付平台API)    │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  记录查单审计日志      │
                         │  action=QUERY         │
                         └───────────┬───────────┘
                                     │
            ┌────────────────────────┼────────────────────────┐
            │                        │                        │
            ▼                        ▼                        ▼
   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
   │ 查询结果=SUCCESS │     │ 查询结果=FAILED │     │ 查询结果=PAYING │
   └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
            │                       │                       │
            ▼                       ▼                       ▼
   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
   │ CAS更新为SUCCESS │     │ CAS更新为FAILED │     │ 检查是否过期     │
   │ 补发MQ事件       │     └────────┬────────┘     └────────┬────────┘
   └────────┬────────┘              │                       │
            │                       │              ┌────────┴────────┐
            ▼                       ▼              │                 │
   ┌─────────────────┐     ┌─────────────────┐    ▼                 ▼
   │ 记录审计日志     │     │ 记录审计日志     │  ┌──────────┐  ┌──────────┐
   │ action=NOTIFY   │     │ action=NOTIFY   │  │ 已过期    │  │ 未过期    │
   │ PAYING->SUCCESS │     │ PAYING->FAILED  │  │ 关闭支付单 │  │ 等待下次  │
   └─────────────────┘     └─────────────────┘  └──────────┘  │ 扫描      │
                                                              └──────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ 查询结果=NOT_FOUND    │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ CAS关闭支付单          │
                         │ close_reason=         │
                         │ "渠道无此订单记录"     │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ 记录审计日志           │
                         │ action=CLOSE          │
                         │ PAYING->CLOSED        │
                         └───────────────────────┘
```

## 3. 支付成功事件传播与一致性保证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    支付成功事件传播与一致性保证                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  payment-service │     │    RocketMQ     │     │  order-service  │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         │  1. 回调处理成功       │                       │
         │  CAS更新状态为SUCCESS  │                       │
         │                       │                       │
         │  2. 发送PaymentSucceeded                      │
         │─────────────────────>│                       │
         │                       │                       │
         │                       │  3. 投递消息          │
         │                       │─────────────────────>│
         │                       │                       │
         │                       │                       │  4. 幂等检查
         │                       │                       │  (t_mq_consume_log)
         │                       │                       │
         │                       │                       │  5. 状态机校验
         │                       │                       │  canTransition?
         │                       │                       │
         │                       │                       │  6. CAS更新订单
         │                       │                       │  STOCK_RESERVED->PAID
         │                       │                       │
         │                       │                       │  7. 记录状态流转
         │                       │                       │  (t_order_state_flow)
         │                       │                       │
         │                       │  8. ACK确认           │
         │                       │<─────────────────────│
         │                       │                       │

一致性保证机制：
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. 回调幂等：基于 callbackId (MD5(payNo+timestamp+nonce)) 唯一约束           │
│ 2. 消费幂等：基于 t_mq_consume_log (event_id + consumer_group) 唯一约束      │
│ 3. 状态更新：CAS乐观锁 WHERE status=期望状态                                 │
│ 4. 乱序处理：状态机校验 + 忽略记录审计                                       │
│ 5. 补单机制：定时扫描超时订单，主动查单补推进                                 │
│ 6. 审计追踪：t_pay_callback_log + t_pay_reconcile_audit                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 4. 完整支付流程时序图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           完整支付流程时序图                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────┐  ┌──────────────┐  ┌────────────────┐  ┌─────────┐  ┌──────────────┐
│Client│  │order-service │  │payment-service │  │RocketMQ │  │第三方支付平台 │
└──┬───┘  └──────┬───────┘  └───────┬────────┘  └────┬────┘  └──────┬───────┘
   │             │                  │                │              │
   │ 1.创建订单   │                  │                │              │
   │────────────>│                  │                │              │
   │             │                  │                │              │
   │             │ 2.发送ORDER_CREATED               │              │
   │             │─────────────────────────────────>│              │
   │             │                  │                │              │
   │             │                  │  (库存预留成功后)              │
   │             │                  │                │              │
   │ 3.创建支付单 │                  │                │              │
   │────────────────────────────────>│               │              │
   │             │                  │                │              │
   │             │                  │ 4.幂等创建     │              │
   │             │                  │ (按order_no)   │              │
   │             │                  │                │              │
   │<────────────────────────────────│               │              │
   │   返回支付单信息(payNo)         │               │              │
   │             │                  │                │              │
   │ 5.调用支付   │                  │                │              │
   │─────────────────────────────────────────────────────────────>│
   │             │                  │                │              │
   │             │                  │                │  6.支付回调   │
   │             │                  │<─────────────────────────────│
   │             │                  │                │              │
   │             │                  │ 7.验签+幂等    │              │
   │             │                  │ CAS更新状态    │              │
   │             │                  │                │              │
   │             │                  │ 8.发送PAYMENT_SUCCEEDED       │
   │             │                  │───────────────>│              │
   │             │                  │                │              │
   │             │  9.消费事件       │                │              │
   │             │<─────────────────────────────────│              │
   │             │                  │                │              │
   │             │ 10.幂等检查      │                │              │
   │             │ CAS更新订单状态   │                │              │
   │             │ STOCK_RESERVED   │                │              │
   │             │    -> PAID       │                │              │
   │             │                  │                │              │
   │ 11.查询订单  │                  │                │              │
   │────────────>│                  │                │              │
   │<────────────│                  │                │              │
   │  订单状态=PAID                 │                │              │
   │             │                  │                │              │
```

## 5. 状态机定义

### 支付单状态机

```
                    ┌─────────────────────────────────────────┐
                    │           支付单状态机                   │
                    └─────────────────────────────────────────┘

                              ┌──────────┐
                              │   INIT   │ (初始化)
                              └────┬─────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
             ┌──────────┐   ┌──────────┐   ┌──────────┐
             │  PAYING  │   │  SUCCESS │   │  CLOSED  │
             │ (支付中)  │   │ (成功)   │   │ (已关闭) │
             └────┬─────┘   └──────────┘   └──────────┘
                  │              ▲              ▲
                  │              │              │
                  ├──────────────┘              │
                  │     回调成功                │
                  │                            │
                  ├────────────────────────────┘
                  │     超时关闭/渠道无记录
                  │
                  ▼
             ┌──────────┐
             │  FAILED  │ (失败)
             └──────────┘

状态说明：
- INIT: 支付单已创建，等待用户支付
- PAYING: 已调用支付渠道，等待回调
- SUCCESS: 支付成功（终态）
- FAILED: 支付失败（终态）
- CLOSED: 已关闭（超时/手动关闭）（终态）
```

### 订单状态机（含支付）

```
                    ┌─────────────────────────────────────────┐
                    │           订单状态机（含支付）            │
                    └─────────────────────────────────────────┘

                              ┌──────────┐
                              │ CREATED  │ (已创建)
                              └────┬─────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
          ┌──────────────┐  ┌──────────────┐  ┌──────────┐
          │STOCK_RESERVED│  │ STOCK_FAILED │  │ CANCELED │
          │ (库存已预留)  │  │ (库存失败)   │  │ (已取消) │
          └──────┬───────┘  └──────────────┘  └──────────┘
                 │                                  ▲
                 │                                  │
                 ├──────────────────────────────────┘
                 │     用户取消
                 │
                 ▼
            ┌──────────┐
            │   PAID   │ (已支付)
            └──────────┘
                 │
                 ▼
            (后续可扩展: SHIPPED, COMPLETED, REFUNDED...)

状态转换事件：
- CREATE: 创建订单 -> CREATED
- STOCK_RESERVED: 库存预留成功 -> STOCK_RESERVED
- STOCK_RESERVE_FAILED: 库存预留失败 -> STOCK_FAILED
- CANCEL: 取消订单 -> CANCELED
- PAYMENT_SUCCESS: 支付成功 -> PAID
```

## 6. 数据一致性保证总结

| 场景 | 保证机制 | 实现方式 |
|------|----------|----------|
| 支付单创建幂等 | order_no唯一约束 | `UNIQUE KEY uk_order_no (order_no)` |
| 回调幂等 | callbackId唯一约束 | `UNIQUE KEY uk_callback_id (callback_id)` |
| 消费幂等 | event_id+consumer_group唯一约束 | `UNIQUE KEY uk_event_consumer (event_id, consumer_group)` |
| 状态更新原子性 | CAS乐观锁 | `WHERE status = 期望状态` |
| 乱序消息处理 | 状态机校验 | `canTransition(currentStatus, event)` |
| 消息丢失补偿 | 定时补单 | `PaymentReconcileScheduler` |
| 审计追踪 | 日志表 | `t_pay_callback_log`, `t_pay_reconcile_audit` |
