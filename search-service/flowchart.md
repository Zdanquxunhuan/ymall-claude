# Search Service 索引流程图

## 1. 索引构建流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           商品发布/更新流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Product    │     │   Outbox     │     │  RocketMQ    │     │   Search     │
│   Service    │────▶│    Table     │────▶│   PRODUCT    │────▶│   Service    │
│              │     │              │     │    TOPIC     │     │              │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
       │                    │                    │                    │
       │  1. 发布商品        │  2. 写入Outbox     │  3. 投递消息        │  4. 消费&索引
       │  (事务内)          │  (同事务)          │  (异步)            │  (幂等)
       ▼                    ▼                    ▼                    ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  SKU状态变更  │     │ OutboxRelay  │     │ PRODUCT_     │     │ Memory/ES    │
│  PUBLISHED   │     │   Worker     │     │ PUBLISHED    │     │   Index      │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
```

## 2. 消息消费与幂等处理

```
                    ┌─────────────────────────────────────┐
                    │        ProductEventConsumer         │
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │      1. 解析消息 (BaseEvent)         │
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │      2. 设置 TraceId (链路追踪)       │
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │      3. 幂等检查 (Redis)             │
                    │      Key: mq:PRODUCT_TOPIC:msgId    │
                    └─────────────────────────────────────┘
                                      │
                         ┌────────────┴────────────┐
                         │                         │
                    已处理过                     未处理
                         │                         │
                         ▼                         ▼
                    ┌─────────┐          ┌─────────────────┐
                    │  跳过   │          │ 4. 业务幂等检查   │
                    │  返回   │          │ (eventId去重)    │
                    └─────────┘          └─────────────────┘
                                                  │
                                     ┌────────────┴────────────┐
                                     │                         │
                                eventId已处理              eventId未处理
                                     │                         │
                                     ▼                         ▼
                                ┌─────────┐          ┌─────────────────┐
                                │  跳过   │          │ 5. 构建文档      │                         │  返回   │          │ ProductDocument │
                                └─────────┘          └─────────────────┘
                                                              │
                                                              ▼
                                                   ┌─────────────────┐
                                                   │ 6. 写入索引      │
                                                   │ (Memory/ES)     │
                                                   └─────────────────┘
                                                              │
                                                              ▼
                                                   ┌─────────────────┐
                                                   │ 7. 记录eventId   │
                                                   │ (防重复写入)     │
                                                   └─────────────────┘
```

## 3. 索引最终一致性保证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           最终一致性机制                                      │
└─────────────────────────────────────────────────────────────────────────────┘

1. Transactional Outbox Pattern
   ┌────────────────────────────────────────────────────────────────────────┐
   │  商品发布事务                                                           │
   │  ┌─────────────────┐    ┌─────────────────┐                           │
   │  │ UPDATE sku SET  │    │ INSERT INTO     │                           │
   │  │ status='PUB'    │ +  │ t_outbox(...)   │  ──▶ 同一事务，原子性保证   │
   │  └─────────────────┘    └─────────────────┘                           │
   └────────────────────────────────────────────────────────────────────────┘

2. At-Least-Once Delivery
   ┌────────────────────────────────────────────────────────────────────────┐
   │  消息投递保证                                                           │
   │  • OutboxRelayWorker 定时轮询未发送消息                                  │
   │  • 发送失败自动重试（指数退避）                                           │
   │  • 消费失败自动重试（最多5次）                                            │
   └────────────────────────────────────────────────────────────────────────┘

3. Idempotent Consumer
   ┌────────────────────────────────────────────────────────────────────────┐
   │  幂等消费保证                                                           │
   │  • 第一层：Redis 消息ID去重（ConsumerTemplate）                          │
   │  • 第二层：eventId 业务去重（SearchIndexService）                        │
   │  • 重复消息不会导致索引数据异常                                           │
   └────────────────────────────────────────────────────────────────────────┘
```

## 4. 索引重建任务（占位）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        索引重建任务 (TODO)                                   │
└─────────────────────────────────────────────────────────────────────────────┘

触发场景：
  • 索引数据丢失或损坏
  • 索引结构变更需要重建
  • 定期全量同步保证一致性

重建流程（待实现）：
  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
  │  1. 创建     │     │  2. 分批     │     │  3. 切换     │
  │  新索引      │────▶│  导入数据    │────▶│  索引别名    │
  └──────────────┘     └──────────────┘     └──────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
  product_index_v2     从DB批量读取SKU      alias指向新索引
                       写入新索引            删除旧索引

配置项：
  search:
    rebuild:
      enabled: false          # 是否启用重建任务
      batch-size: 100         # 每批处理数量
      cron: "0 0 3 * * ?"     # 执行时间（每天凌晨3点）

实现要点：
  • 使用游标分页避免深分页问题
  • 支持断点续传
  • 重建期间不影响正常搜索
  • 完成后自动切换，零停机
```

## 5. 搜索请求流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           搜索请求处理流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

GET /search?q=手机&categoryId=1&sort=price&order=asc&pageNum=1&pageSize=20

                    ┌─────────────────────────────────────┐
                    │         SearchController            │
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │      1. 参数校验与构建请求            │
                    │         SearchRequest               │
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │      2. 调用 SearchIndexService      │
                    │         search(request)             │
                    └─────────────────────────────────────┘
                                      │
              ┌───────────────────────┴───────────────────────┐
              │                                               │
        Memory Index                                    ES Index
              │                                               │
              ▼                                               ▼
    ┌─────────────────┐                           ┌─────────────────┐
    │ 3a. 关键词分词   │                           │ 3b. 构建ES查询   │
    │ 倒排索引查找     │                           │ BoolQuery       │
    │ 交集运算        │                           │                 │
    └─────────────────┘                           └─────────────────┘
              │                                               │
              ▼                                               ▼
    ┌─────────────────┐                           ┌─────────────────┐
    │ 4a. 过滤        │                           │ 4b. ES执行查询   │
    │ (价格范围等)    │                           │                 │
    └─────────────────┘                           └─────────────────┘
              │                                               │
              ▼                                               ▼
    ┌─────────────────┐                           ┌─────────────────┐
    │ 5a. 排序        │                           │ 5b. 解析结果     │
    │ (内存排序)      │                           │                 │
    └─────────────────┘                           └─────────────────┘
              │                                               │
              ▼                                               ▼
    ┌─────────────────┐                           ┌─────────────────┐
    │ 6a. 分页        │                           │ 6b. 返回结果     │
    │ (subList)       │                           │                 │
    └─────────────────┘                           └─────────────────┘
              │                                               │
              └───────────────────────┬───────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │      7. 返回 SearchResult            │
                    │      (items, total, pageInfo)       │
                    └─────────────────────────────────────┘
```

## 6. 数据流向总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流向总览                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │   Admin     │
                              │   Console   │
                              └──────┬──────┘
                                     │ 发布商品
                                     ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                            Product Service                                   │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                      │
│  │  SKU Table  │    │ Outbox Table│    │ OutboxRelay │                      │
│  │  (MySQL)    │───▶│  (MySQL)    │───▶│   Worker    │                      │
│  └─────────────┘    └─────────────┘    └──────┬──────┘                      │
└──────────────────────────────────────────────┼───────────────────────────────┘
                                               │
                                               ▼
                              ┌─────────────────────────────┐
                              │        RocketMQ             │
                              │      PRODUCT_TOPIC          │
                              │  (PRODUCT_PUBLISHED/UPDATED)│
                              └──────────────┬──────────────┘
                                             │
                                             ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                            Search Service                                    │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐          │
│  │ ProductEvent    │    │ SearchIndex     │    │ SearchController│          │
│  │ Consumer        │───▶│ Service         │◀───│ (REST API)      │          │
│  └─────────────────┘    └────────┬────────┘    └─────────────────┘          │
│                                  │                      ▲                    │
│                    ┌─────────────┴─────────────┐        │                    │
│                    ▼                           ▼        │                    │
│           ┌─────────────────┐         ┌─────────────────┐                   │
│           │  Memory Index   │         │   ES Index      │                   │
│           │ (ConcurrentMap) │         │  (Optional)     │                   │
│           └─────────────────┘         └─────────────────┘                   │
└──────────────────────────────────────────────────────────────────────────────┘
                                             ▲
                                             │ 搜索请求
                                             │
                              ┌─────────────────────────────┐
                              │         用户/前端            │
                              │   GET /search?q=xxx         │
                              └─────────────────────────────┘
```
