# 流程图文档

## 1. TraceId 链路追踪流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           TraceId 链路追踪流程                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Client  │────▶│ TraceFilter  │────▶│  Controller  │────▶│   Service    │
└──────────┘     └──────────────┘     └──────────────┘     └──────────────┘
     │                  │                    │                    │
     │  Request         │                    │                    │
     │  X-Trace-Id:     │                    │                    │
     │  (optional)      │                    │                    │
     │                  ▼                    │                    │
     │           ┌─────────────┐             │                    │
     │           │ 检查请求头   │             │                    │
     │           │ X-Trace-Id  │             │                    │
     │           └─────────────┘             │                    │
     │                  │                    │                    │
     │           ┌──────┴──────┐             │                    │
     │           │             │             │                    │
     │      有traceId    无traceId           │                    │
     │           │             │             │                    │
     │           ▼             ▼             │                    │
     │      ┌────────┐   ┌──────────┐        │                    │
     │      │ 使用    │   │ 生成新的  │        │                    │
     │      │ 传入的  │   │ traceId  │        │                    │
     │      └────────┘   └──────────┘        │                    │
     │           │             │             │                    │
     │           └──────┬──────┘             │                    │
     │                  ▼                    │                    │
     │           ┌─────────────┐             │                    │
     │           │ 设置到       │             │                    │
     │           │ TraceContext│             │                    │
     │           │ + MDC       │             │                    │
     │           └─────────────┘             │                    │
     │                  │                    │                    │
     │                  ▼                    ▼                    ▼
     │           ┌─────────────────────────────────────────────────┐
     │           │              业务处理（日志自动带traceId）         │
     │           │  log.info("[traceId=xxx] Processing...")        │
     │           └─────────────────────────────────────────────────┘
     │                                       │
     │                                       ▼
     │                              ┌─────────────┐
     │                              │ 响应头回传   │
     │                              │ X-Trace-Id  │
     │                              └─────────────┘
     │                                       │
     ◀───────────────────────────────────────┘
     Response
     X-Trace-Id: xxx


日志输出示例:
┌────────────────────────────────────────────────────────────────────────────┐
│ 2024-01-15 10:30:45.123 [http-nio-8081-exec-1] [abc123def456] INFO ...    │
│                                                ▲                          │
│                                                │                          │
│                                           traceId                         │
└────────────────────────────────────────────────────────────────────────────┘
```

## 2. 幂等处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              幂等处理流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Client  │────▶│IdempotentAsp │────▶│    Redis     │────▶│   Service    │
└──────────┘     └──────────────┘     └──────────────┘     └──────────────┘
     │                  │                    │                    │
     │  POST /demo/idempotent               │                    │
     │  Header: X-Idempotency-Key: key123   │                    │
     │                  │                    │                    │
     │                  ▼                    │                    │
     │           ┌─────────────┐             │                    │
     │           │ 提取幂等键   │             │                    │
     │           │ key123      │             │                    │
     │           └─────────────┘             │                    │
     │                  │                    │                    │
     │                  ▼                    │                    │
     │           ┌─────────────┐             │                    │
     │           │ 构建完整Key  │             │                    │
     │           │ demo:order: │             │                    │
     │           │ key123      │             │                    │
     │           └─────────────┘             │                    │
     │                  │                    │                    │
     │                  ▼                    ▼                    │
     │           ┌─────────────────────────────────┐              │
     │           │  Redis SETNX (Lua原子操作)       │              │
     │           │  尝试获取幂等锁                  │              │
     │           └─────────────────────────────────┘              │
     │                  │                    │                    │
     │           ┌──────┴──────┐             │                    │
     │           │             │             │                    │
     │       获取成功      Key已存在          │                    │
     │           │             │             │                    │
     │           ▼             ▼             │                    │
     │    ┌──────────┐  ┌─────────────┐      │                    │
     │    │ 执行业务  │  │ 检查状态     │      │                    │
     │    │ 逻辑     │  │ PROCESSING/ │      │                    │
     │    │          │  │ SUCCESS     │      │                    │
     │    └──────────┘  └─────────────┘      │                    │
     │           │             │             │                    │
     │           │      ┌──────┴──────┐      │                    │
     │           │      │             │      │                    │
     │           │  PROCESSING    SUCCESS    │                    │
     │           │      │             │      │                    │
     │           │      ▼             ▼      │                    │
     │           │  ┌────────┐  ┌─────────┐  │                    │
     │           │  │返回:    │  │返回:     │  │                    │
     │           │  │请求处理 │  │缓存的    │  │                    │
     │           │  │中,请勿  │  │结果      │  │                    │
     │           │  │重复提交 │  │          │  │                    │
     │           │  │A0401   │  │          │  │                    │
     │           │  └────────┘  └─────────┘  │                    │
     │           │                           │                    │
     │           ▼                           │                    ▼
     │    ┌──────────────────────────────────────────────────────────┐
     │    │                    执行业务逻辑                           │
     │    │                    创建订单...                            │
     │    └──────────────────────────────────────────────────────────┘
     │           │                           │                    │
     │           ▼                           │                    │
     │    ┌──────────────────────────────────────────────────────────┐
     │    │  更新Redis状态为SUCCESS，存储结果                         │
     │    │  TTL: 24小时                                             │
     │    └──────────────────────────────────────────────────────────┘
     │           │                           │                    │
     ◀───────────┴───────────────────────────┘                    │
     Response: {"code":"00000", "data":{...}}


Redis 数据结构:
┌────────────────────────────────────────────────────────────────────────────┐
│ Key: idempotent:demo:order:key123                                         │
│ Value: {                                                                   │
│   "key": "demo:order:key123",                                             │
│   "status": "SUCCESS",                                                     │
│   "result": "{\"id\":123,\"orderNo\":\"ORD...\"}",                        │
│   "traceId": "abc123def456",                                              │
│   "createdAt": 1705289445000,                                             │
│   "expireAt": 1705375845000                                               │
│ }                                                                          │
│ TTL: 86400 (24小时)                                                        │
└────────────────────────────────────────────────────────────────────────────┘
```

## 3. 限流处理流程 (令牌桶算法)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         限流处理流程 (令牌桶算法)                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Client  │────▶│RateLimitAsp  │────▶│    Redis     │────▶│   Service    │
└──────────┘     └──────────────┘     └──────────────┘     └──────────────┘
     │                  │                    │                    │
     │  GET /demo/ratelimit                 │                    │
     │                  │                    │                    │
     │                  ▼                    │                    │
     │           ┌─────────────┐             │                    │
     │           │ 构建限流Key  │             │                    │
     │           │ api:Demo    │             │                    │
     │           │ Controller. │             │                    │
     │           │ rateLimitDemo│            │                    │
     │           └─────────────┘             │                    │
     │                  │                    │                    │
     │                  ▼                    ▼                    │
     │           ┌─────────────────────────────────┐              │
     │           │     Redis Lua 脚本执行           │              │
     │           │     令牌桶算法                   │              │
     │           └─────────────────────────────────┘              │
     │                  │                    │                    │
     │                  ▼                    │                    │
     │           ┌─────────────────────────────────┐              │
     │           │  1. 获取当前令牌数和上次填充时间  │              │
     │           │  2. 计算需要添加的令牌数         │              │
     │           │     elapsed = now - lastRefill  │              │
     │           │     tokensToAdd = elapsed*rate  │              │
     │           │  3. 更新令牌数(不超过容量)       │              │
     │           │  4. 判断是否有足够令牌           │              │
     │           └─────────────────────────────────┘              │
     │                  │                    │                    │
     │           ┌──────┴──────┐             │                    │
     │           │             │             │                    │
     │       有令牌        无令牌            │                    │
     │       (allowed=1)  (allowed=0)        │                    │
     │           │             │             │                    │
     │           ▼             ▼             │                    │
     │    ┌──────────┐  ┌─────────────┐      │                    │
     │    │ 扣减令牌  │  │ 返回限流    │      │                    │
     │    │ 继续执行  │  │ 错误码      │      │                    │
     │    │          │  │ A0500      │      │                    │
     │    └──────────┘  └─────────────┘      │                    │
     │           │             │             │                    │
     │           ▼             │             │                    │
     │    ┌──────────────────────────────────────────────────────────┐
     │    │                    执行业务逻辑                           │
     │    └──────────────────────────────────────────────────────────┘
     │           │             │             │                    │
     ◀───────────┴─────────────┘             │                    │
     │                                       │                    │
     │  成功: {"code":"00000", ...}          │                    │
     │  限流: {"code":"A0500", "message":"请求过于频繁..."}         │


令牌桶算法示意图:
┌────────────────────────────────────────────────────────────────────────────┐
│                                                                            │
│    令牌生成速率: 200/秒                                                     │
│         │                                                                  │
│         ▼                                                                  │
│    ┌─────────┐                                                             │
│    │ ● ● ● ● │ ◀── 令牌桶 (容量: 200)                                      │
│    │ ● ● ● ● │                                                             │
│    │ ● ● ●   │ ◀── 当前令牌数                                              │
│    └────┬────┘                                                             │
│         │                                                                  │
│         ▼                                                                  │
│    ┌─────────┐     ┌─────────┐     ┌─────────┐                            │
│    │ Request │     │ Request │     │ Request │                            │
│    │   ✓     │     │   ✓     │     │   ✗     │ ◀── 无令牌,拒绝             │
│    └─────────┘     └─────────┘     └─────────┘                            │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘


Redis 数据结构:
┌────────────────────────────────────────────────────────────────────────────┐
│ Key: ratelimit:api:DemoController.rateLimitDemo                           │
│ Type: Hash                                                                 │
│ Fields:                                                                    │
│   - tokens: 198 (当前令牌数)                                               │
│   - lastRefillTime: 1705289445123 (上次填充时间戳)                         │
│ TTL: 动态计算 (约 capacity/rate * 2 + 1 秒)                                │
└────────────────────────────────────────────────────────────────────────────┘
```

## 4. 整体请求处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           整体请求处理流程                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              HTTP Request
                                   │
                                   ▼
                         ┌─────────────────┐
                         │  TraceFilter    │
                         │  生成/透传traceId│
                         │  设置MDC        │
                         └────────┬────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │ RateLimitAspect │
                         │ 限流检查        │
                         │ (Order=0)       │
                         └────────┬────────┘
                                  │
                         ┌────────┴────────┐
                         │                 │
                    通过限流           触发限流
                         │                 │
                         ▼                 ▼
                ┌─────────────────┐  ┌─────────────┐
                │IdempotentAspect│  │ 返回A0500   │
                │ 幂等检查        │  │ 限流错误    │
                │ (Order=1)      │  └─────────────┘
                └────────┬───────┘
                         │
                ┌────────┴────────┐
                │                 │
           首次请求          重复请求
                │                 │
                ▼                 ▼
        ┌─────────────┐   ┌─────────────┐
        │ Controller  │   │ 返回缓存结果 │
        │ 业务处理    │   │ 或处理中提示 │
        └──────┬──────┘   └─────────────┘
               │
               ▼
        ┌─────────────┐
        │  Service    │
        │  业务逻辑   │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │ Repository  │
        │ 数据访问    │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │  Database   │
        │  MySQL      │
        └──────┬──────┘
               │
               ▼
        ┌─────────────────────────────────────────┐
        │ GlobalExceptionHandler                  │
        │ 统一异常处理，返回标准Result格式          │
        │ 包含traceId                             │
        └─────────────────────────────────────────┘
               │
               ▼
        ┌─────────────────────────────────────────┐
        │ HTTP Response                           │
        │ Header: X-Trace-Id: xxx                 │
        │ Body: {"code":"00000","traceId":"xxx"}  │
        └─────────────────────────────────────────┘
```

## 5. MQ 消息处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MQ 消息处理流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

生产者流程:
┌──────────┐     ┌──────────────┐     ┌──────────────┐
│ Service  │────▶│ProducerTempl │────▶│  RocketMQ    │
└──────────┘     └──────────────┘     └──────────────┘
     │                  │                    │
     │  发送消息         │                    │
     │                  ▼                    │
     │           ┌─────────────┐             │
     │           │ 构建BaseEvent│            │
     │           │ - messageId │             │
     │           │ - traceId   │             │
     │           │ - payload   │             │
     │           └─────────────┘             │
     │                  │                    │
     │                  ▼                    ▼
     │           ┌─────────────────────────────────┐
     │           │  发送到 RocketMQ                 │
     │           │  Topic: xxx                     │
     │           │  Tag: xxx                       │
     │           │  Keys: businessKey/messageId   │
     │           └─────────────────────────────┘


消费者流程:
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  RocketMQ    │────▶│ConsumerTempl │────▶│   Service    │
└──────────────┘     └──────────────┘     └──────────────┘
     │                    │                    │
     │  推送消息           │                    │
     │                    ▼                    │
     │             ┌─────────────┐             │
     │             │ 解析消息     │             │
     │             │ 提取traceId │             │
     │             │ 设置MDC     │             │
     │             └─────────────┘             │
     │                    │                    │
     │                    ▼                    │
     │             ┌─────────────┐             │
     │             │ 幂等检查     │             │
     │             │ Redis       │             │
     │             └─────────────┘             │
     │                    │                    │
     │             ┌──────┴──────┐             │
     │             │             │             │
     │         首次消费      重复消费           │
     │             │             │             │
     │             ▼             ▼             │
     │      ┌──────────┐  ┌─────────────┐      │
     │      │ 执行业务  │  │ 跳过处理    │      │
     │      │ doConsume│  │ 返回成功    │      │
     │      └──────────┘  └─────────────┘      │
     │             │                           │
     │             ▼                           │
     │      ┌──────────────────────────────────────┐
     │      │ 异常处理:                             │
     │      │ - reconsumeTimes < 3: 重试           │
     │      │ - reconsumeTimes >= 3: 进入DLQ       │
     │      └──────────────────────────────────────┘
```

## 6. Transactional Outbox Relay 架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Order Service                                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │
│  │   Client    │───▶│ Controller  │───▶│  Service    │───▶│ Repository  │       │
│  └─────────────┘    └─────────────┘    └─────────────┘    └──────┬──────┘       │
│                                                                   │              │
│                                              ┌────────────────────┼──────────┐   │
│                                              │   Same Transaction │          │   │
│                                              │         ▼          ▼          │   │
│                                              │  ┌──────────┐ ┌──────────┐    │   │
│                                              │  │ t_order  │ │t_outbox_ │    │   │
│                                              │  │          │ │  event   │    │   │
│                                              │  └──────────┘ └──────────┘    │   │
│                                              └───────────────────────────────┘   │
│                                                                   │              │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                        Outbox Relay Worker                               │    │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐              │    │
│  │  │  Poll   │───▶│  Lock   │───▶│  Send   │───▶│ Update  │              │    │
│  │  │ (1s)    │    │ (SKIP   │    │ RocketMQ│    │ Status  │              │    │
│  │  │         │    │ LOCKED) │    │         │    │         │              │    │
│  │  └─────────┘    └─────────┘    └─────────┘    └─────────┘              │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                         │                        │
└─────────────────────────────────────────────────────────┼────────────────────────┘
                                                          │
                                                          ▼
                                               ┌─────────────────────┐
                                               │      RocketMQ       │
                                               │   (ORDER_TOPIC)     │
                                               └──────────┬──────────┘
                                                          │
                                                          ▼
                                               ┌─────────────────────┐
                                               │  OrderCreated       │
                                               │    Consumer         │
                                               └──────────┬──────────┘
                                                          │
                                                          ▼
                                               ┌─────────────────────┐
                                               │  t_mq_consume_log   │
                                               │   (Idempotent)      │
                                               └─────────────────────┘
```

## 7. Outbox Relay Worker 流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         OutboxRelayWorker.relay()                            │
│                           (每秒执行一次)                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │  SELECT * FROM t_outbox_event │
                    │  WHERE status IN ('NEW','RETRY')│
                    │  AND next_retry_at <= NOW()   │
                    │  FOR UPDATE SKIP LOCKED       │
                    │  LIMIT 100                    │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                         ┌──────────────────┐
                         │  有待处理事件？   │
                         └────────┬─────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ Yes                       │ No
                    ▼                           ▼
        ┌───────────────────┐           ┌─────────────┐
        │  遍历处理每个事件  │           │   返回等待   │
        └─────────┬─────────┘           └─────────────┘
                  │
                  ▼
    ┌─────────────────────────────┐
    │  设置 TraceContext          │
    │  (从 event.traceId 恢复)    │
    └─────────────┬───────────────┘
                  │
                  ▼
    ┌─────────────────────────────┐
    │  构建 RocketMQ Message      │
    │  - KEYS = event_id          │
    │  - Header: traceId          │
    │  - Body: BaseEvent JSON     │
    └─────────────┬───────────────┘
                  │
                  ▼
    ┌─────────────────────────────┐
    │  rocketMQTemplate.syncSend()│
    └─────────────┬───────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
   ┌─────────┐         ┌─────────┐
   │ 成功    │         │ 失败    │
   └────┬────┘         └────┬────┘
        │                   │
        ▼                   ▼
┌───────────────┐   ┌───────────────────────┐
│ markAsSent()  │   │ handleSendFailure()   │
│ status='SENT' │   │                       │
│ sent_at=NOW() │   │                       │
└───────────────┘   └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
               ▼                       ▼
          ┌─────────────────┐     ┌─────────────────┐
          │ retryCount <    │     │ retryCount >=   │
          │ maxRetry        │     │ maxRetry        │
          └────────┬────────┘     └────────┬────────┘
                   │                       │
                   ▼                       ▼
          ┌─────────────────┐     ┌─────────────────┐
          │ markAsRetry()   │     │ markAsDead()    │
          │ status='RETRY'  │     │ status='DEAD'   │
          │ 指数退避计算     │     │ 告警日志        │
          │ next_retry_at   │     │ [ALERT]         │
          └─────────────────┘     └─────────────────┘
```

## 8. 指数退避重试策略

```
重试次数    延迟时间（baseInterval=5s）
────────    ─────────────────────────
   1        5s   (5 * 2^0)
   2        10s  (5 * 2^1)
   3        20s  (5 * 2^2)
   4        40s  (5 * 2^3)
   5        80s  (5 * 2^4)
   ...      ...
   max      3600s (1小时，上限)

┌─────────────────────────────────────────────────────────────────┐
│                    Retry Timeline                                │
│                                                                  │
│  NEW ──5s──▶ RETRY ──10s──▶ RETRY ──20s──▶ RETRY ──40s──▶ ...  │
│   │           │              │              │                    │
│   │           │              │              │                    │
│   ▼           ▼              ▼              ▼                    │
│ 发送失败    发送失败       发送失败      发送失败                │
│                                                                  │
│  超过 maxRetry (默认5次) 后:                                     │
│                                                                  │
│  RETRY ────────────────────────────────────────────────▶ DEAD   │
│                                                           │      │
│                                                           ▼      │
│                                                    [ALERT 告警]  │
└─────────────────────────────────────────────────────────────────┘
```

## 9. 消费幂等流程 (DB-based)

```
┌─────────────────────────────────────────────────────────────────┐
│                   OrderCreatedConsumer.onMessage()               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │  解析消息 BaseEvent   │
                  │  提取 eventId, bizKey │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │  设置 TraceContext    │
                  │  (从消息恢复 traceId) │
                  └───────────┬───────────┘
                              │
                              ▼
            ┌─────────────────────────────────────┐
            │  mqConsumeLogRepository.tryAcquire()│
            │  尝试插入 t_mq_consume_log          │
            │  (event_id + consumer_group 唯一)  │
            └─────────────────┬───────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  插入成功       │             │  已存在记录     │
    │  (首次消费)     │             │  (重复消费)     │
    └────────┬────────┘             └────────┬────────┘
             │                               │
             ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  执行业务逻辑   │             │  检查状态       │
    │  doConsume()    │             │                 │
    └────────┬────────┘             └────────┬────────┘
             │                               │
             │                    ┌──────────┼──────────┐
             │                    │          │          │
             │                    ▼          ▼          ▼
             │              ┌─────────┐ ┌─────────┐ ┌─────────┐
             │              │ SUCCESS │ │PROCESSING│ │ FAILED │
             │              └────┬────┘ └────┬────┘ └────┬────┘
             │                   │           │           │
             │                   ▼           ▼           ▼
             │              ┌─────────┐ ┌─────────┐ ┌─────────┐
             │              │ 跳过    │ │ 抛异常  │ │ 允许    │
             │              │ (幂等)  │ │ 重试    │ │ 重试    │
             │              └─────────┘ └─────────┘ └─────────┘
             │
    ┌────────┴────────┐
    │                 │
    ▼                 ▼
┌─────────┐     ┌─────────┐
│ 成功    │     │ 异常    │
└────┬────┘     └────┬────┘
     │               │
     ▼               ▼
┌───────────┐   ┌───────────┐
│markSuccess│   │markFailed │
│status=    │   │status=    │
│'SUCCESS'  │   │'FAILED'   │
└───────────┘   └───────────┘
```

## 10. Outbox Event 状态流转

```
                    ┌─────────────────────────────────────────┐
                    │           t_outbox_event                │
                    └─────────────────────────────────────────┘

                              ┌───────┐
                              │  NEW  │ ◀── 业务写入 (同一事务)
                              └───┬───┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
              ┌───────────┐              ┌───────────┐
              │   SENT    │              │   RETRY   │
              │ (发送成功) │              │ (发送失败) │
              └───────────┘              └─────┬─────┘
                    ▲                          │
                    │                          │
                    │            ┌─────────────┴─────────────┐
                    │            │                           │
                    │            ▼                           ▼
                    │      ┌───────────┐              ┌───────────┐
                    └──────│   RETRY   │              │   DEAD    │
                           │ (重试成功) │              │ (超过阈值) │
                           └───────────┘              └───────────┘
                                                            │
                                                            ▼
                                                     ┌─────────────┐
                                                     │ [ALERT]     │
                                                     │ 告警日志    │
                                                     └─────────────┘
```

## 11. 水平扩展支持

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Multiple Relay Workers                                │
│                                                                              │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│   │  Worker 1   │    │  Worker 2   │    │  Worker 3   │                     │
│   │  (Pod 1)    │    │  (Pod 2)    │    │  (Pod 3)    │                     │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                     │
│          │                  │                  │                             │
│          │    FOR UPDATE SKIP LOCKED           │                             │
│          │                  │                  │                             │
│          ▼                  ▼                  ▼                             │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                      t_outbox_event                              │       │
│   │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐       │       │
│   │  │ E1  │ │ E2  │ │ E3  │ │ E4  │ │ E5  │ │ E6  │ │ E7  │ ...   │       │
│   │  │     │ │     │ │     │ │     │ │     │ │     │ │     │       │       │
│   │  │ W1  │ │ W2  │ │ W3  │ │ W1  │ │ W2  │ │ W3  │ │ W1  │       │       │
│   │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘       │       │
│   │                                                                  │       │
│   │  每个 Worker 获取不同的行锁，互不干扰                            │       │
│   └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

关键点：
1. FOR UPDATE SKIP LOCKED - 跳过已被锁定的行
2. 每个 Worker 独立获取未被锁定的事件
3. 乐观锁 version 字段防止并发更新冲突
4. 无需分布式锁，数据库行锁即可保证
```

## 12. 可靠性保证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Reliability Guarantees                               │
└─────────────────────────────────────────────────────────────────────────────┘

1. 事务一致性 (Transactional Outbox)
   ┌─────────────────────────────────────────────────────────────────┐
   │  @Transactional                                                  │
   │  public void createOrder() {                                     │
   │      orderRepository.save(order);        // 业务数据             │
   │      outboxRepository.saveEvent(...);    // Outbox 事件          │
   │  }                                                               │
   │  // 同一事务，要么都成功，要么都回滚                              │
   └─────────────────────────────────────────────────────────────────┘

2. At-Least-Once 投递
   ┌─────────────────────────────────────────────────────────────────┐
   │  - Relay Worker 定时扫描                                         │
   │  - 发送失败自动重试（指数退避）                                   │
   │  - 消息一定会被投递（除非标记为 DEAD）                            │
   └─────────────────────────────────────────────────────────────────┘

3. 消费幂等
   ┌─────────────────────────────────────────────────────────────────┐
   │  - t_mq_consume_log 唯一索引 (event_id, consumer_group)         │
   │  - 消费前检查，消费后记录                                        │
   │  - 重复消息自动跳过                                              │
   └─────────────────────────────────────────────────────────────────┘

4. Broker 故障恢复
   ┌─────────────────────────────────────────────────────────────────┐
   │  Broker Down:                                                    │
   │    - 发送失败 → status='RETRY', next_retry_at=指数退避           │
   │    - 消息保留在 Outbox 表中                                      │
   │                                                                  │
   │  Broker Up:                                                      │
   │    - Relay Worker 继续扫描                                       │
   │    - 到达 next_retry_at 后重新投递                               │
   │    - 消息最终送达                                                │
   └─────────────────────────────────────────────────────────────────┘
```

## 13. 监控指标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Monitoring Metrics                                 │
└─────────────────────────────────────────────────────────────────────────────┘

1. Outbox 积压监控
   SELECT status, COUNT(*) FROM t_outbox_event GROUP BY status;
   
   告警阈值：
   - NEW 状态 > 1000 条 → 告警（Relay 可能故障）
   - RETRY 状态 > 100 条 → 告警（Broker 可能故障）
   - DEAD 状态 > 0 条 → 告警（需要人工介入）

2. 消费延迟监控
   SELECT AVG(cost_ms), MAX(cost_ms) FROM t_mq_consume_log 
   WHERE created_at > NOW() - INTERVAL 5 MINUTE;

3. 关键日志
   - [OutboxRelay] Event sent successfully → 投递成功
   - [OutboxRelay] [ALERT] Event marked as DEAD → 死信告警
   - [OrderCreatedConsumer] Message consumed successfully → 消费成功
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MQ 消息处理流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

生产者流程:
┌──────────┐     ┌──────────────┐     ┌──────────────┐
│ Service  │────▶│ProducerTempl │────▶│  RocketMQ    │
└──────────┘     └──────────────┘     └──────────────┘
     │                  │                    │
     │  发送消息         │                    │
     │                  ▼                    │
     │           ┌─────────────┐             │
     │           │ 构建BaseEvent│            │
     │           │ - messageId │             │
     │           │ - traceId   │             │
     │           │ - payload   │             │
     │           └─────────────┘             │
     │                  │                    │
     │                  ▼                    ▼
     │           ┌─────────────────────────────────┐
     │           │  发送到 RocketMQ                 │
     │           │  Topic: xxx                     │
     │           │  Tag: xxx                       │
     │           │  Keys: businessKey/messageId   │
     │           └─────────────────────────────────┘


消费者流程:
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  RocketMQ    │────▶│ConsumerTempl │────▶│   Service    │
└──────────────┘     └──────────────┘     └──────────────┘
     │                    │                    │
     │  推送消息           │                    │
     │                    ▼                    │
     │             ┌─────────────┐             │
     │             │ 解析消息     │             │
     │             │ 提取traceId │             │
     │             │ 设置MDC     │             │
     │             └─────────────┘             │
     │                    │                    │
     │                    ▼                    │
     │             ┌─────────────┐             │
     │             │ 幂等检查     │             │
     │             │ Redis       │             │
     │             └─────────────┘             │
     │                    │                    │
     │             ┌──────┴──────┐             │
     │             │             │             │
     │         首次消费      重复消费           │
     │             │             │             │
     │             ▼             ▼             │
     │      ┌──────────┐  ┌─────────────┐      │
     │      │ 执行业务  │  │ 跳过处理    │      │
     │      │ doConsume│  │ 返回成功    │      │
     │      └──────────┘  └─────────────┘      │
     │             │                           │
     │             ▼                           │
     │      ┌──────────────────────────────────────┐
     │      │ 异常处理:                             │
     │      │ - reconsumeTimes < 3: 重试           │
     │      │ - reconsumeTimes >= 3: 进入DLQ       │
     │      └──────────────────────────────────────┘
```
